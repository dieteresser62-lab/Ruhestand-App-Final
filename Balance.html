<!DOCTYPE html>
<html lang="de" data-density="compact">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruhestand-Balancing</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="css/balance.css">

    <!-- External Scripts -->
    <script type="module" src="engine.js"></script>
    <script type="module" src="balance-main.js"></script>
</head>
<body>
    <div class="main-layout">
        <div id="engine-version-alert" role="alert" tabindex="-1" style="display:none; padding: 15px; background-color: var(--warning-color); color: #000; font-weight: bold; text-align: center; margin-bottom: 15px; border-radius: 8px; grid-column: 1 / -1;"></div>

        <!-- Debug-Modus Indikator -->
        <div id="debugModeIndicator" style="display: none; padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; text-align: center; margin-bottom: 10px; border-radius: 8px; grid-column: 1 / -1; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
            üêõ DEBUG-MODUS AKTIV | CTRL+Shift+D zum Deaktivieren
        </div>

        <div class="form-column panel">
            <div class="app-header">
                <h1>Ruhestand-Balancing</h1>
                <div class="app-controls">
                    <button id="jahresabschlussBtn" type="button" class="btn" aria-label="Jahresabschluss erstellen (Alt+J)">‚≠ê Jahresabschluss</button>
                    <button id="exportBtn" type="button" class="btn" aria-label="Export (Alt+E)">üì§ Export</button>
                    <button id="importBtn" type="button" class="btn" aria-label="Import (Alt+I)">üì• Import</button>
                    <input id="importFile" type="file" accept="application/json,.json" style="display:none">
                </div>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="update">Jahres-Update</button>
                <button class="tab-btn" data-tab="settings">Grundeinstellungen & Strategie</button>
            </div>

            <div class="tab-content">
                <div id="tab-update" class="tab-panel active">
                    <fieldset><legend>Basiswerte</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label for="aktuellesAlter">Aktuelles Alter</label><input id="aktuellesAlter" type="number" value="65" min="50"></div>
                            <div class="form-group">
                                <label for="inflation">Inflation VJ (%)</label>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <input id="inflation" type="number" value="1.7" step="0.1" style="flex: 1;">
                                    <button id="btnFetchInflation" type="button" class="btn btn-utility btn-sm" title="Inflation online abrufen">üåê API</button>
                                </div>
                            </div>
                        </div>
						<!-- NEUER CONTAINER F√úR DEN INTELLIGENTEN HINWEIS -->
						<div id="bedarfAnpassungContainer" class="full-width" style="margin-top: 10px; text-align: center;"></div>						
                    </fieldset>
                    <fieldset><legend>Verm√∂gen</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label for="tagesgeld">Tagesgeld (‚Ç¨)</label><input id="tagesgeld" class="currency" type="text" inputmode="numeric" value="60000"></div>
                            <div class="form-group"><label for="geldmarktEtf">Geldmarkt-ETF (‚Ç¨)</label><input id="geldmarktEtf" class="currency" type="text" inputmode="numeric" value="360000"></div>
                            <div class="form-group"><label for="depotwertAlt">Depotwert Alt (‚Ç¨)</label><input id="depotwertAlt" class="currency" type="text" inputmode="numeric" placeholder="z. B. 1.200.000"></div>
                            <div class="form-group"><label for="depotwertNeu">Depotwert Neu (‚Ç¨)</label><input id="depotwertNeu" class="currency" type="text" inputmode="numeric" placeholder="z. B. 750.000"></div>
                            <div class="form-group" id="goldWertGroup"><label for="goldWert">Gold-Bestand (‚Ç¨)</label><input id="goldWert" class="currency" type="text" inputmode="numeric" value="0"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend style="display: flex; justify-content: space-between; align-items: center; width: 100%;">Marktdaten
                        <span style="display: flex; gap: 6px;">
                            <button id="btnCsvImport" type="button" class="btn btn-utility btn-sm" title="Marktdaten aus CSV-Datei importieren">üìÑ CSV</button>
                            <input type="file" id="csvFileInput" accept=".csv" style="display:none">
                            <button id="btnNachruecken" type="button" class="btn btn-utility btn-sm" title="Marktdaten um ein Jahr verschieben (Alt+N)">üóìÔ∏è Nachr.</button>
                            <button id="btnUndoNachruecken" type="button" class="btn btn-utility btn-sm" title="Nachr√ºcken r√ºckg√§ngig machen" style="display:none;">‚Ü©Ô∏è</button>
                        </span>
                    </legend>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="form-group"><label for="endeVJ">Ende VJ</label><input type="number" id="endeVJ" value="2318" min="0" step="0.01"></div>
                            <div class="form-group"><label for="endeVJ_1">Ende VJ-1</label><input type="number" id="endeVJ_1" value="1960" min="0" step="0.01"></div>
                            <div class="form-group"><label for="ath">Allzeithoch</label><input type="number" id="ath" value="2318" min="0" step="0.01"></div>
                            <div class="form-group"><label for="endeVJ_2">Ende VJ-2</label><input type="number" id="endeVJ_2" value="1850" min="0" step="0.01"></div>
                            <div class="form-group"><label for="endeVJ_3">Ende VJ-3</label><input type="number" id="endeVJ_3" value="1706" min="0" step="0.01"></div>
                            <div class="form-group"><label for="jahreSeitAth">Jahre seit ATH</label><input type="number" id="jahreSeitAth" value="0" step="0.01" min="0"></div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Externe Eink√ºnfte</legend>
                      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                          <label for="renteAktiv">Rente aktiv</label>
                          <select id="renteAktiv">
                            <option value="nein">Nein</option>
                            <option value="ja">Ja</option>
                          </select>
                        </div>
                        <div class="form-group" id="renteMonatlichGroup">
                          <label for="renteMonatlich">Gesetzl. Rente (‚Ç¨/Monat)</label>
                          <input id="renteMonatlich" class="currency" type="text" inputmode="numeric" value="0" disabled>
                        </div>
                      </div>
                    </fieldset>
                </div>

                <div id="tab-settings" class="tab-panel">
                    <fieldset><legend>Bedarfsplanung</legend>
						<div class="form-grid" style="grid-template-columns: 1fr 1fr;">
						    <div class="form-group"><label for="floorBedarf" title="Essenzielle Ausgaben pro Jahr">Floor-Bedarf p.a. (‚Ç¨)</label><input id="floorBedarf" class="currency" type="text" inputmode="numeric" value="24000"></div>
						    <div class="form-group"><label for="flexBedarf" title="W√ºnschenswerte, aber k√ºrzbare Ausgaben pro Jahr">Flex-Bedarf p.a. (‚Ç¨)</label><input id="flexBedarf" class="currency" type="text" inputmode="numeric" value="28000"></div>
						</div>
					</fieldset>
                    <fieldset><legend>Runway-Steuerung</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="runwayMinMonths" title="Das absolute Minimum an Liquidit√§tsreichweite, das nicht unterschritten werden soll. L√∂st im B√§renmarkt ggf. Not-Auff√ºllungen aus.">Runway Minimum (Monate)</label>
                                <input id="runwayMinMonths" type="number" value="24" min="12" max="60" step="1">
                            </div>
                            <div class="form-group">
                                <label for="runwayTargetMonths" title="Die angestrebte, komfortable Liquidit√§tsreichweite. Wird in guten Marktphasen proaktiv aufgef√ºllt (Skim & Fill).">Runway Ziel (Monate)</label>
                                <input id="runwayTargetMonths" type="number" value="36" min="18" max="72" step="1">
                            </div>
                        </div>
                    </fieldset>
                    <fieldset><legend>Rebalancing-Strategie</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px 20px;">
                            <div class="form-group">
                                <label for="targetEq" title="Die angestrebte prozentuale Allokation in Aktien. Dient als Anker f√ºr das Rebalancing.">Aktien-Zielquote (%)</label>
                                <input id="targetEq" type="number" value="60" min="20" max="90" step="1">
                            </div>
                            <div class="form-group">
                                <label for="rebalBand" title="Die prozentuale Toleranz um die Zielquote, bevor ein Rebalancing ausgel√∂st wird.">Rebalancing-Band (¬±%)</label>
                                <input id="rebalBand" type="number" value="5" min="1" max="20" step="0.5">
                            </div>
                            <div class="form-group">
                                <label for="maxSkimPctOfEq" title="Der maximal pro Jahr abzusch√∂pfende Betrag (als Prozentsatz des Aktiendepots), um die Liquidit√§t aufzuf√ºllen.">Max. Absch√∂pfen p.a. (%)</label>
                                <input id="maxSkimPctOfEq" type="number" value="10" min="0" max="25" step="1">
                            </div>
                            <!-- ============================================= -->
                            <!-- NEUES FELD F√úR BEAR-MODE-DRIP                 -->
                            <!-- ============================================= -->
                            <div class="form-group">
                                <label for="maxBearRefillPctOfEq" title="Der maximal pro Jahr zu verkaufende Betrag (als Prozentsatz des Aktiendepots) im B√§renmarkt, um die Runway bis zum Minimum aufzuf√ºllen.">Max. Auff√ºllen (B√§r) (%)</label>
                                <input id="maxBearRefillPctOfEq" type="number" value="5" min="0" max="15" step="0.5">
                            </div>
                            <!-- ============================================= -->
                            <!-- ENDE NEUES FELD                               -->
                            <!-- ============================================= -->
                        </div>
                    </fieldset>
                    <fieldset><legend>Steuern</legend><div class="form-grid">
                        <div class="form-group"><label for="kirchensteuerSatz">Kirchensteuer</label><select id="kirchensteuerSatz"><option value="0">0 %</option><option value="0.08">8 %</option><option value="0.09" selected>9 %</option></select></div>
                        <div class="form-group"><label for="sparerPauschbetrag">Sparer-PB (‚Ç¨)</label><input id="sparerPauschbetrag" class="currency" type="text" inputmode="numeric" value="1000"></div>
                    </div></fieldset>
                    <fieldset><legend>Gold-Strategie</legend>
                        <div class="form-group full-width">
                            <label style="flex-direction: row; align-items: center; justify-content: center; padding: 5px 0;">
                                <input type="checkbox" id="goldAktiv" class="goldAktiv" style="width: auto; margin-right: 8px;">Gold-Allokation aktiv
                            </label>
                        </div>
                        <div id="goldPanel" style="display: none;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 15px 20px; align-items: end;">
                                <div class="form-group"><label for="goldZielProzent">Ziel-Allokation (% v. Depot)</label><input type="number" id="goldZielProzent" value="7.5" step="0.5"></div>
                                <div class="form-group"><label for="goldFloorProzent">Gold-Floor (% v. Gesamt)</label><input type="number" id="goldFloorProzent" value="1" step="0.5"></div>
                                <div class="form-group"><label for="rebalancingBand">Rebalancing-Band (¬±%)</label><input type="number" id="rebalancingBand" value="25" step="5"></div>
                                <div class="form-group full-width" style="grid-column: 1 / -1; justify-content:center; margin-top: 5px;"><label style="display:flex; align-items:center; flex-direction: row;"><input type="checkbox" id="goldSteuerfrei" style="width:auto; margin-right:8px;"> Gold-Verk√§ufe steuerfrei</label></div>
                            </div>
                        </div>
                    </fieldset>
                    <details id="einstandDetails" class="details-card" aria-label="Einstandswerte"><summary aria-controls="einstandContent">Einstandswerte & Teilfreistellung</summary>
                        <div class="einstand-hinweis">Selten √§ndern ‚Äì wird automatisch gespeichert.</div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: start;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="costBasisAlt">Einstand Alt (‚Ç¨)</label><input id="costBasisAlt" class="currency" type="text" inputmode="numeric" value="700000"></div>
                                <div class="form-group"><label for="tqfAlt">TQF Alt</label><input id="tqfAlt" type="number" step="0.01" min="0" max="1" value="0.30"></div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="costBasisNeu">Einstand Neu (‚Ç¨)</label><input id="costBasisNeu" class="currency" type="text" inputmode="numeric" value="750000"></div>
                                <div class="form-group"><label for="tqfNeu">TQF Neu</label><input id="tqfNeu" type="number" step="0.01" min="0" max="1" value="0.30"></div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="goldCost">Gold-Einstand (‚Ç¨)</label><input id="goldCost" class="currency" type="text" inputmode="numeric" value="0"></div>
                            </div>
                        </div>
                    </details>
                    
                    <details id="snapshot-management" class="details-card" style="margin-top: 25px;">
                        <summary>Jahresabschluss-Snapshots</summary>
                        <div style="padding: 10px 0 5px 0;">
                            <button type="button" class="btn btn-sm" id="connectFolderBtn" style="width: 100%;">Lokalen Snapshot-Ordner verbinden</button>
                            <div id="snapshotStatus" class="snapshot-status">Speicherort: Browser (localStorage)</div>
                        </div>
                        <ul id="snapshotList" style="list-style: none; padding: 10px 0 0 0; margin: 0; font-size: 0.9rem;">
                        </ul>
                    </details>
					<button type="button" class="reset-button" id="resetBtn">Gespeicherte Werte zur√ºcksetzen</button>
                </div>
            </div>
        </div>
        <div class="results-column panel" role="region" aria-live="polite">
            <div id="results" role="status">
                <h2>
                    Ergebnisse & Handlungsschritte
                    <button id="openDiagnosisBtn" type="button" class="btn btn-sm btn-utility" title="Diagnosepanel √∂ffnen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path><path d="M12 18a6 6 0 0 0 0-12V2a10 10 0 0 0-9.9 12"></path><path d="M12 12h.01"></path></svg>
                        Diagnose
                    </button>
                </h2>
                <div class="mini-summary" id="miniSummary"></div>
                <div id="error-container" aria-live="polite"></div>
                <div class="result-item"><strong>Gesamt-Depotwert:</strong><span id="displayDepotwert"></span></div>
                <div class="result-item"><strong>Gesamtjahresbedarf:</strong><span id="neuerBedarf"></span></div>
                <div class="result-item" id="minGoldRow"><strong>Gold-Mindestbestand:</strong><span id="minGoldDisplay"></span></div>
                <hr>
                <div class="result-item"><strong>Ziel-Liquidit√§t:</strong><span id="zielLiquiditaet"></span></div>
                <div class="progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"><div id="liquiditaetBalken" class="progress-bar"></div></div>
                <hr>
                <div class="result-item" id="marktstatusRow"><strong style="padding-right:10px">Marktsituation:</strong><span id="marktstatusText"></span></div>
                <div class="result-item"><strong>Monatliche Entnahme:</strong><span id="monatlicheEntnahme"></span></div>
                <details class="details-card" id="entnahme-breakdown" style="margin-top: 10px; display: none;"><summary>Details zur Entnahme</summary>
                    <div style="margin-top: 10px; font-size: 0.9rem; line-height: 1.5;" id="entnahmeDetailsContent"></div>
                </details>

                <div id="handlungsanweisung"><button id="copyAction" type="button" class="btn btn-sm btn-utility" title="Handlung kopieren">üìã</button></div>
                
                <div id="print-footer"></div>
            </div>
        </div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay"></div>
    <div id="diagnosisDrawer" class="diagnosis-drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
        <div class="drawer-header">
            <h3 id="drawerTitle">KI-Diagnose</h3>
            <div class="controls">
                <label style="font-weight:400; font-size: .8rem; margin:0;"><input type="checkbox" id="diagFilterToggle" style="width:auto; margin-right: 5px;">Nur aktive Regeln</label>
                <button id="copyDiagnosisBtn" type="button" class="btn btn-sm btn-utility" title="Diagnose kopieren">üìã</button>
                <button id="closeDiagnosisBtn" type="button" class="btn btn-sm" title="Schlie√üen">&times;</button>
            </div>
        </div>
        <div id="diagContent" class="drawer-content">
            <div class="diag-section">
                <h4>Status-√úbersicht</h4>
                <div id="diag-chips" class="diag-chips"></div>
            </div>
            <div class="diag-section">
                <h4>Entscheidungsbaum (Warum?)</h4>
                <ul id="diag-decision-tree"></ul>
            </div>
            <div class="diag-section">
                <h4>Guardrails</h4>
                <div id="diag-guardrails" class="diag-guardrails"></div>
            </div>
            <div class="diag-section">
                <h4>Transaktions-Diagnostik</h4>
                <div id="diag-transaction" class="diag-guardrails diag-transaction"></div>
            </div>
            <div class="diag-section">
                <h4>Schl√ºsselparameter (Intern)</h4>
                <div id="diag-key-params"></div>
            </div>
        </div>
    </div>


</body>
</html>
