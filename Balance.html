<!DOCTYPE html>
<html lang="de" data-density="compact">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruhestand-Balancing</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="css/balance.css">

    <!-- External Scripts -->
    <script type="module" src="app/profile/profile-bridge.js"></script>
    <script type="module" src="engine.js"></script>
    <script type="module" src="app/balance/balance-main.js"></script>
</head>

<body>
    <div class="main-layout">
        <div id="engine-version-alert" role="alert" tabindex="-1"
            style="display:none; padding: 15px; background-color: var(--warning-color); color: #000; font-weight: bold; text-align: center; margin-bottom: 15px; border-radius: 8px; grid-column: 1 / -1;">
        </div>

        <div class="form-column panel">
            <div class="app-header">
                <h1>Ruhestand-Balancing</h1>
                <div class="app-controls">
                    <button id="jahresabschlussBtn" type="button" class="btn"
                        aria-label="Jahresabschluss erstellen (Alt+J)">‚≠ê Jahresabschluss</button>
                    <button id="exportBtn" type="button" class="btn" aria-label="Export (Alt+E)">üì§ Export</button>
                    <button id="importBtn" type="button" class="btn" aria-label="Import (Alt+I)">üì• Import</button>
                    <input id="importFile" type="file" accept="application/json,.json" style="display:none">
                    <a href="index.html" class="btn"
                        style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;"
                        aria-label="Startseite √∂ffnen">üè† Startseite</a>
                    <a href="Handbuch.html" target="_blank" class="btn"
                        style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;"
                        aria-label="Handbuch √∂ffnen">üìñ Hilfe</a>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="update">Jahres-Update</button>
                <button class="tab-btn" data-tab="settings">Grundeinstellungen & Strategie</button>
                <button class="tab-btn" data-tab="ausgaben">Ausgaben-Check</button>
            </div>

            <div class="tab-content">
                <div id="tab-update" class="tab-panel active">
                    <fieldset>
                        <legend>Basiswerte</legend>
                        <!-- Jahres-Update Button -->
                        <!-- Compact Header Row -->
                        <div class="basiswerte-header-row basiswerte-header-compact">
                            <div class="profilverbund-toggle-target profilverbund-header-group profilverbund-compact" style="display:none;">
                                <div class="profilverbund-title">Profilverbund</div>
                                <div class="profilverbund-controls-inline">
                                    <label for="profilverbund-withdrawal-mode">Verteilung</label>
                                    <select id="profilverbund-withdrawal-mode">
                                        <option value="tax_optimized">Steueroptimiert</option>
                                        <option value="proportional">Proportional</option>
                                        <option value="runway_first">Runway-First</option>
                                    </select>
                                </div>
                                <div class="profilverbund-profile-strip">
                                    <div id="profilverbund-profile-list" class="profilverbund-profile-list compact"></div>
                                </div>
                            </div>
                            <div class="basiswerte-divider profilverbund-toggle-target" aria-hidden="true" style="display:none;"></div>
                            <div class="update-primary-actions update-actions-compact">
                                <button id="btnJahresUpdate" type="button" class="btn btn-primary"
                                    title="Ruft Inflation (ECB) und ETF-Kurs (VWCE.DE) ab, f√ºhrt Nachr√ºcken durch und aktualisiert ATH">üåê
                                    Jahres-Update</button>
                                <div class="annual-update-steps" aria-label="Jahres-Update Schritte">
                                    <span class="step-dot" title="Inflation abrufen"></span>
                                    <span class="step-dot" title="Kurse aktualisieren"></span>
                                    <span class="step-dot" title="Alter erh√∂hen"></span>
                                </div>
                                <button id="btnJahresUpdateLog" type="button" class="btn btn-utility btn-icon"
                                    aria-label="Protokoll des letzten Jahres-Updates anzeigen"
                                    title="Protokoll des letzten Jahres-Updates anzeigen" disabled>üßæ</button>
                            </div>
                        </div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <input id="profilName" type="hidden">
                            <input id="aktuellesAlter" type="hidden">
                            <div class="form-group">
                                <label for="fixedIncomeAnnual">Feste Einkuenfte (‚Ç¨/Jahr)</label>
                                <input id="fixedIncomeAnnual" type="text" inputmode="numeric" disabled>
                            </div>
                            <div class="form-group">
                                <label for="inflation">Inflation VJ (%)</label>
                                <input id="inflation" type="number" placeholder="0" step="0.1"
                                    title="Inflationsrate des Vorjahres - wird automatisch von der EZB abgerufen und dient zur Anpassung Ihrer Bedarfswerte">
                            </div>
                        </div>
                        <!-- NEUER CONTAINER F√úR DEN INTELLIGENTEN HINWEIS -->
                        <div id="bedarfAnpassungContainer" class="full-width"
                            style="margin-top: 10px; text-align: center;"></div>
                    </fieldset>
                    <fieldset>
                        <legend>Verm√∂gen</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label for="tagesgeld">Tagesgeld (‚Ç¨)</label><input id="tagesgeld"
                                    class="currency" type="text" inputmode="numeric" placeholder="0" disabled
                                    title="Wird im Profil-Assets Manager gepflegt">
                            </div>
                            <div class="form-group"><label for="geldmarktEtf">Geldmarkt-ETF (‚Ç¨)</label><input
                                    id="geldmarktEtf" class="currency" type="text" inputmode="numeric" placeholder="0"
                                    disabled
                                    title="Ihr Geldmarkt-ETF-Bestand - sehr sichere, kurzfristig verf√ºgbare Anlage mit leicht h√∂herer Rendite als Tagesgeld">
                            </div>
                            <div class="form-group"><label for="depotwertGesamt">Depotwert gesamt (‚Ç¨)</label><input
                                    id="depotwertGesamt" class="currency" type="text" inputmode="numeric"
                                    placeholder="z. B. 1.950.000" disabled
                                    title="Gesamtwert Ihres Depots (aus Tranchen/Profilen aggregiert)">
                            </div>
                            <div class="form-group" id="goldWertGroup"><label for="goldWert">Gold-Bestand
                                    (‚Ç¨)</label><input id="goldWert" class="currency" type="text" inputmode="numeric"
                                    disabled value="0"
                                    title="Aktueller Wert Ihres physischen Gold-Bestands (optional, wenn Gold-Strategie aktiv)">
                            </div>
                            <input id="depotwertAlt" type="hidden">
                            <input id="depotwertNeu" type="hidden">
                        </div>
                        <details class="tranchen-status-details">
                            <summary>Tranchenstatus anzeigen</summary>
                            <div id="tranchenStatusBadge"></div>
                        </details>
                    </fieldset>
                    <fieldset>
                        <legend
                            style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            Marktdaten
                            <span style="display: flex; gap: 6px;">
                                <button id="btnCsvImport" type="button" class="btn btn-utility btn-sm"
                                    title="Marktdaten aus CSV-Datei importieren">üìÑ CSV</button>
                                <input type="file" id="csvFileInput" accept=".csv" style="display:none">
                                <button id="btnNachruecken" type="button" class="btn btn-utility btn-sm"
                                    title="Marktdaten um ein Jahr verschieben (Alt+N)">üóìÔ∏è Nachr.</button>
                                <button id="btnUndoNachruecken" type="button" class="btn btn-utility btn-sm"
                                    title="Nachr√ºcken r√ºckg√§ngig machen" style="display:none;">‚Ü©Ô∏è</button>
                            </span>
                        </legend>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="form-group"><label for="endeVJ">Ende VJ</label><input type="number" id="endeVJ"
                                    min="0" step="0.01" placeholder="0"></div>
                            <div class="form-group"><label for="endeVJ_1">Ende VJ-1</label><input type="number"
                                    id="endeVJ_1" min="0" step="0.01" placeholder="0"></div>
                            <div class="form-group"><label for="ath">Allzeithoch</label><input type="number" id="ath"
                                    min="0" step="0.01" placeholder="0"></div>
                            <div class="form-group"><label for="endeVJ_2">Ende VJ-2</label><input type="number"
                                    id="endeVJ_2" min="0" step="0.01" placeholder="0"></div>
                            <div class="form-group"><label for="endeVJ_3">Ende VJ-3</label><input type="number"
                                    id="endeVJ_3" min="0" step="0.01" placeholder="0"></div>
                            <div class="form-group"><label for="jahreSeitAth">Jahre seit ATH</label><input type="number"
                                    id="jahreSeitAth" step="0.01" min="0" placeholder="0"></div>
                        </div>
                    </fieldset>
                    <input id="renteAktiv" type="hidden">
                    <input id="renteMonatlich" type="hidden">
                </div>

                <div id="tab-settings" class="tab-panel">
                    <fieldset>
                        <legend>Bedarfsplanung</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"> <label for="floorBedarf">Floor-Bedarf (‚Ç¨/Jahr)</label> <input
                                    id="floorBedarf" class="currency" type="text" inputmode="numeric" value="12000">
                            </div>
                            <div class="form-group"> <label for="flexBedarf">Flex-Bedarf (‚Ç¨/Jahr)</label> <input
                                    id="flexBedarf" class="currency" type="text" inputmode="numeric" value="24000">
                            </div>
                        </div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top: 12px;">
                            <div class="form-group">
                                <label for="flexBudgetAnnual">Flex-Budget Cap (‚Ç¨/Jahr)</label>
                                <input id="flexBudgetAnnual" class="currency" type="text" inputmode="numeric" value="7000"
                                    title="Maximaler Flex-Betrag pro Krisenjahr (inflationsbereinigt). 0 = deaktiviert.">
                            </div>
                            <div class="form-group">
                                <label for="flexBudgetYears">Flex-Budget Jahre</label>
                                <input id="flexBudgetYears" type="number" min="0" max="10" step="0.5" value="5"
                                    title="Maximale Topfgr√∂√üe in Jahren (Cap * Jahre).">
                            </div>
                            <div class="form-group">
                                <label for="flexBudgetRecharge">Flex-Budget Recharge (‚Ç¨/Jahr)</label>
                                <input id="flexBudgetRecharge" class="currency" type="text" inputmode="numeric" value="5000"
                                    title="Wie schnell der Flex-Topf in Nicht-Krisenjahren wieder aufgef√ºllt wird.">
                            </div>
                        </div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top: 12px;">
                            <div class="form-group"><label for="marketCapeRatio">CAPE (Shiller)</label><input
                                    type="number" id="marketCapeRatio" value="32" step="0.1" min="0"
                                    title="Aktuelles Shiller-CAPE (Cyclically Adjusted Price-to-Earnings Ratio) - Bewertungskennzahl f√ºr den Aktienmarkt">
                            </div>
                            <div class="form-group"><label for="dynamicFlexPreset">Dynamic-Flex Profil</label><select
                                    id="dynamicFlexPreset"
                                    title="Einfaches Profil f√ºr Dynamic-Flex: Details werden automatisch gesetzt">
                                    <option value="off">Aus</option>
                                    <option value="konservativ">Konservativ</option>
                                    <option value="ausgewogen" selected>Ausgewogen</option>
                                    <option value="offensiv">Offensiv</option>
                                    <option value="custom">Benutzerdefiniert</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dynamicFlexShowAdvanced" style="display:block;">Erweiterte Parameter</label>
                                <label for="dynamicFlexShowAdvanced" class="inline-toggle">
                                    <input type="checkbox" id="dynamicFlexShowAdvanced"
                                        title="Zeigt Detailparameter f√ºr Dynamic-Flex an">
                                    <span>Anzeigen</span>
                                </label>
                            </div>
                        </div>
                        <div id="dynamicFlexAdvancedToggleRow" class="form-grid"
                            style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                            <div class="form-group">
                                <label for="dynamicFlex" style="display:block;">Dynamic Flex (VPW) aktivieren</label>
                                <label for="dynamicFlex" class="inline-toggle">
                                    <input type="checkbox" id="dynamicFlex"
                                        title="Steuert den Flex-Bedarf dynamisch per VPW-Logik (nur Flex-Anteil, Floor bleibt fix)">
                                    <span>Aktiv</span>
                                </label>
                            </div>
                        </div>
                        <div id="dynamicFlexConfigGroup" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group"><label for="horizonMethod">Horizon-Methode</label><select
                                    id="horizonMethod"
                                    title="Methode f√ºr die Restlaufzeitberechnung des VPW-Faktors">
                                    <option value="survival_quantile" selected>Survival-Quantile</option>
                                    <option value="mean">Erwartungswert</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="horizonYears">Horizon Jahre</label><input
                                    type="number" id="horizonYears" value="30" min="1" max="60" step="1"
                                    title="Direkte Vorgabe der Restlaufzeit in Jahren (validiert 1 bis 60)">
                            </div>
                            <div class="form-group"><label for="survivalQuantile">Survival-Quantil</label><input
                                    type="number" id="survivalQuantile" value="0.85" min="0.5" max="0.99" step="0.01"
                                    title="Quantil f√ºr aktuarische Restlaufzeit (0.5 bis 0.99)">
                            </div>
                            <div class="form-group">
                                <label for="goGoActive" style="display:block;">Go-Go Phase aktivieren</label>
                                <label for="goGoActive" class="inline-toggle">
                                    <input type="checkbox" id="goGoActive"
                                        title="Aktiviert tempor√§ren VPW-Flex-Aufschlag in der Go-Go-Phase">
                                    <span>Aktiv</span>
                                </label>
                            </div>
                            <div class="form-group"><label for="goGoMultiplier">Go-Go Multiplikator</label><input
                                    type="number" id="goGoMultiplier" value="1.1" min="1" max="10" step="0.05"
                                    title="Multiplikator auf VPW-Flex in Go-Go-Jahren (1.0 bis 10.0)">
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Runway-Steuerung</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="runwayMinMonths">Runway Minimum (Monate)</label>
                                <input id="runwayMinMonths" type="number" min="12" max="60" step="1"
                                    title="Das absolute Minimum an Liquidit√§tsreichweite, das nicht unterschritten werden soll. L√∂st im B√§renmarkt ggf. Not-Auff√ºllungen aus."
                                    value="24">
                            </div>
                            <div class="form-group">
                                <label for="runwayTargetMonths">Runway Ziel (Monate)</label>
                                <input id="runwayTargetMonths" type="number" min="18" max="72" step="1"
                                    title="Die angestrebte, komfortable Liquidit√§tsreichweite. Wird in guten Marktphasen proaktiv aufgef√ºllt (Skim & Fill)."
                                    value="36">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label for="minCashBufferMonths">Min. Cash-Puffer (Monate)</label>
                            <input id="minCashBufferMonths" type="number" min="0" max="12" step="1"
                                title="Anzahl an Monatsausgaben (Brutto), die immer auf dem Tagesgeld verbleiben sollen, auch wenn keine Entnahme n√∂tig ist."
                                value="2">
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Rebalancing-Strategie</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px 20px;">
                            <div class="form-group">
                                <label for="targetEq">Aktien-Zielquote (%)</label>
                                <input id="targetEq" type="number" min="20" max="90" step="1"
                                    title="Die angestrebte prozentuale Allokation in Aktien. Dient als Anker f√ºr das Rebalancing."
                                    value="60">
                            </div>
                            <div class="form-group">
                                <label for="rebalBand">Rebalancing-Band (¬±%)</label>
                                <input id="rebalBand" type="number" min="1" max="20" step="0.5"
                                    title="Die prozentuale Toleranz um die Zielquote, bevor ein Rebalancing ausgel√∂st wird."
                                    value="5">
                            </div>
                            <div class="form-group">
                                <label for="maxSkimPctOfEq">Max. Absch√∂pfen p.a. (%)</label>
                                <input id="maxSkimPctOfEq" type="number" min="0" max="25" step="1"
                                    title="Der maximal pro Jahr abzusch√∂pfende Betrag (als Prozentsatz des Aktiendepots), um die Liquidit√§t aufzuf√ºllen."
                                    value="10">
                            </div>
                            <!-- ============================================= -->
                            <!-- NEUES FELD F√úR BEAR-MODE-DRIP                 -->
                            <!-- ============================================= -->
                            <div class="form-group">
                                <label for="maxBearRefillPctOfEq">Max. Auff√ºllen (B√§r) (%)</label>
                                <input id="maxBearRefillPctOfEq" type="number" value="5" min="0" max="15" step="0.5"
                                    title="Der maximal pro Jahr zu verkaufende Betrag (als Prozentsatz des Aktiendepots) im B√§renmarkt, um die Runway bis zum Minimum aufzuf√ºllen.">
                            </div>
                            <!-- ============================================= -->
                            <!-- ENDE NEUES FELD                               -->
                            <!-- ============================================= -->
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Steuern</legend>
                        <div class="form-grid">
                            <div class="form-group"><label for="kirchensteuerSatz">Kirchensteuer</label><select
                                    id="kirchensteuerSatz">
                                    <option value="0">0 %</option>
                                    <option value="0.08">8 %</option>
                                    <option value="0.09" selected>9 %</option>
                                </select></div>
                            <div class="form-group"><label for="sparerPauschbetrag">Sparer-PB (‚Ç¨)</label><input
                                    id="sparerPauschbetrag" class="currency" type="text" inputmode="numeric"
                                    value="1000">
                            </div>
                        </div>
                    </fieldset>
                    <details id="einstandDetails" class="details-card" aria-label="Einstandswerte">
                        <summary aria-controls="einstandContent">Einstandswerte & Teilfreistellung</summary>
                        <div class="einstand-hinweis">Selten √§ndern ‚Äì wird automatisch gespeichert.</div>
                        <div class="form-grid"
                            style="grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: start;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="costBasisAlt">Einstand Alt (‚Ç¨)</label><input
                                        id="costBasisAlt" class="currency" type="text" inputmode="numeric" disabled
                                        placeholder="0" title="Einstand Alt wird aus Profilen/Tranchen aggregiert">
                                </div>
                                <div class="form-group"><label for="tqfAlt">TQF Alt</label><input id="tqfAlt"
                                        type="number" step="0.01" min="0" max="1" placeholder="0"></div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="costBasisNeu">Einstand Neu (‚Ç¨)</label><input
                                        id="costBasisNeu" class="currency" type="text" inputmode="numeric" disabled
                                        placeholder="0" title="Einstand Neu wird aus Profilen/Tranchen aggregiert">
                                </div>
                                <div class="form-group"><label for="tqfNeu">TQF Neu</label><input id="tqfNeu"
                                        type="number" step="0.01" min="0" max="1" placeholder="0"></div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="form-group"><label for="goldCost">Gold-Einstand (‚Ç¨)</label><input
                                        id="goldCost" class="currency" type="text" inputmode="numeric" disabled
                                        placeholder="0" title="Gold-Einstand wird aus Profilen/Tranchen aggregiert">
                                </div>
                            </div>
                        </div>
                    </details>

                    <details id="snapshot-management" class="details-card" style="margin-top: 25px;">
                        <summary>Jahresabschluss-Snapshots</summary>
                        <div style="padding: 10px 0 5px 0;">
                            <button type="button" class="btn btn-sm" id="connectFolderBtn" style="width: 100%;">Lokalen
                                Snapshot-Ordner verbinden</button>
                            <div id="snapshotStatus" class="snapshot-status">Speicherort: Browser (localStorage)</div>
                        </div>
                        <ul id="snapshotList"
                            style="list-style: none; padding: 10px 0 0 0; margin: 0; font-size: 0.9rem;">
                        </ul>
                    </details>
                    <button type="button" class="reset-button" id="resetBtn">Gespeicherte Werte zur√ºcksetzen</button>
                </div>

                <div id="tab-ausgaben" class="tab-panel">
                    <div class="expenses-toolbar">
                        <label class="expenses-year-label" for="expensesYearSelect">Jahr</label>
                        <select id="expensesYearSelect"></select>
                        <div class="expenses-toolbar-hint">Historie bleibt erhalten, Jahresabschluss schaltet auf n√§chstes Jahr.</div>
                    </div>
                    <div class="expenses-summary">
                        <div class="expenses-card">
                            <div class="expenses-card-label">Jahresbudget</div>
                            <div id="expensesAnnualBudget" class="expenses-card-value">‚Äî</div>
                            <div id="expensesMonthlyBudget" class="expenses-card-sub">Monatsbudget: ‚Äî</div>
                        </div>
                        <div class="expenses-card">
                            <div class="expenses-card-label">Noch frei (Jahr)</div>
                            <div id="expensesAnnualRemaining" class="expenses-card-value">‚Äî</div>
                            <div id="expensesAnnualUsed" class="expenses-card-sub">Verbraucht: ‚Äî</div>
                        </div>
                        <div class="expenses-card">
                            <div class="expenses-card-label" title="Prognose: 1 Monat = √ò/Monat, ab 2 Monaten = Median/Monat (robust gegen Ausrei√üer).">Hochrechnung (Jahr)</div>
                            <div id="expensesAnnualForecast" class="expenses-card-value">‚Äî</div>
                            <div id="expensesForecastSub" class="expenses-card-sub">√ò/Monat: ‚Äî</div>
                        </div>
                        <div class="expenses-card">
                            <div class="expenses-card-label">Soll/Ist (Importmonate)</div>
                            <div id="expensesYtdValue" class="expenses-card-value">‚Äî</div>
                            <div id="expensesYtdSub" class="expenses-card-sub">Soll: ‚Äî</div>
                        </div>
                    </div>

                    <div class="expenses-table-wrap">
                        <div id="expensesTable"></div>
                    </div>

                    <input id="expensesCsvInput" type="file" accept=".csv" style="display:none">

                    <dialog id="expensesDetailDialog" class="expenses-dialog">
                        <div class="expenses-dialog-header">
                            <div id="expensesDetailTitle" class="expenses-dialog-title">Details</div>
                            <button id="expensesDetailClose" type="button" class="btn btn-utility btn-sm">Schlie√üen</button>
                        </div>
                        <div id="expensesDetailBody" class="expenses-dialog-body"></div>
                    </dialog>
                </div>
            </div>
        </div>
        <div class="results-column panel" role="region" aria-live="polite">
            <div id="results" role="status">
                <h2>
                    Ergebnisse & Handlungsschritte
                    <button id="openDiagnosisBtn" type="button" class="btn btn-sm btn-utility"
                        title="Diagnosepanel √∂ffnen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path>
                            <path d="M12 18a6 6 0 0 0 0-12V2a10 10 0 0 0-9.9 12"></path>
                            <path d="M12 12h.01"></path>
                        </svg>
                        Diagnose
                    </button>
                </h2>
                <div class="mini-summary" id="miniSummary"></div>
                <div id="error-container" aria-live="polite"></div>

                <!--
                    Kompakte KPI-√úbersicht: Durch die Grid-Anordnung stehen Kennzahlen auf einem normalen Monitor ohne Scrollen zur Verf√ºgung.
                    Die wichtigsten Werte sind gruppiert, Breiten werden automatisch angepasst.
                -->
                <div class="results-kpi-grid" aria-label="Kennzahlen√ºbersicht">
                    <div class="result-item"><strong
                            title="Gesamtwert aller Ihrer Aktiendepots (Alt + Neu) ohne Liquidit√§t und Gold">Gesamt-Depotwert:</strong><span
                            id="displayDepotwert"></span></div>
                    <div class="result-item"><strong
                            title="Ihr inflationsangepasster Jahresbedarf (Floor + Flex) f√ºr das kommende Jahr">Gesamtjahresbedarf:</strong><span
                            id="neuerBedarf"></span></div>
                    <div class="result-item advanced-result" id="minGoldRow"><strong
                            title="Mindestbestand an Gold gem√§√ü Ihrer Gold-Strategie (Gold-Floor als % des Gesamtverm√∂gens)">Gold-Mindestbestand:</strong><span
                            id="minGoldDisplay"></span></div>

                    <!-- Ziel-Liquidit√§t inklusive Fortschrittsbalken als stapelbare Karte, um vertikalen Platz zu sparen. -->
                    <div class="result-item result-item-stack advanced-result" aria-live="polite">
                        <div class="result-item-header">
                            <strong
                                title="Angestrebte Liquidit√§tsreserve basierend auf Ihrer Runway-Ziel-Einstellung">Ziel-Liquidit√§t:</strong>
                            <span id="zielLiquiditaet"></span>
                        </div>
                        <div class="progress-bar-container compact-progress" role="progressbar" aria-valuenow="0"
                            aria-valuemin="0" aria-valuemax="100">
                            <div id="liquiditaetBalken" class="progress-bar"></div>
                        </div>
                    </div>

                    <div class="result-item advanced-result" id="marktstatusRow"><strong style="padding-right:10px"
                            title="Aktuelle Marktphase basierend auf historischen Kursverl√§ufen (Bullenmarkt, B√§renmarkt, Erholung etc.)">Marktsituation:</strong><span
                            id="marktstatusText"></span></div>
                    <div class="result-item"><strong
                            title="Ihre empfohlene monatliche Entnahme aus der Liquidit√§t f√ºr das kommende Jahr">Monatliche
                            Entnahme:</strong><span id="monatlicheEntnahme"></span></div>
                </div>
                <details class="details-card" id="entnahme-breakdown" style="margin-top: 10px; display: none;">
                    <summary>Details zur Entnahme</summary>
                    <div style="margin-top: 10px; font-size: 0.9rem; line-height: 1.5;" id="entnahmeDetailsContent">
                    </div>
                </details>

                <div id="handlungsanweisung"
                    title="Ihre konkreten Handlungsempfehlungen: Welche Transaktionen Sie durchf√ºhren sollten (Rebalancing, Entnahmen, Verk√§ufe etc.)">
                    <button id="copyAction" type="button" class="btn btn-sm btn-utility"
                        title="Handlung kopieren">üìã</button>
                </div>

                <div id="print-footer"></div>
            </div>
        </div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay"></div>
    <div id="diagnosisDrawer" class="diagnosis-drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
        <div class="drawer-header">
            <h3 id="drawerTitle">KI-Diagnose</h3>
            <div class="controls">
                <label style="font-weight:400; font-size: .8rem; margin:0;"><input type="checkbox" id="diagFilterToggle"
                        style="width:auto; margin-right: 5px;">Nur aktive Regeln</label>
                <button id="copyDiagnosisBtn" type="button" class="btn btn-sm btn-utility"
                    title="Diagnose kopieren">üìã</button>
                <button id="closeDiagnosisBtn" type="button" class="btn btn-sm" title="Schlie√üen">&times;</button>
            </div>
        </div>
        <div id="diagContent" class="drawer-content">
            <div class="diag-section">
                <h4>Status-√úbersicht</h4>
                <div id="diag-chips" class="diag-chips"></div>
            </div>
            <div class="diag-section">
                <h4>Entscheidungsbaum (Warum?)</h4>
                <ul id="diag-decision-tree"></ul>
            </div>
            <div class="diag-section">
                <h4>Guardrails</h4>
                <div id="diag-guardrails" class="diag-guardrails"></div>
            </div>
            <div class="diag-section">
                <h4>Transaktions-Diagnostik</h4>
                <div id="diag-transaction" class="diag-guardrails diag-transaction"></div>
            </div>
            <div class="diag-section">
                <h4>Schl√ºsselparameter (Intern)</h4>
                <div id="diag-key-params"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Jahres-Update Ergebnis -->
    <div id="updateResultModal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‚úÖ Jahres-Update erfolgreich</h3>
                <button class="modal-close" aria-label="Schlie√üen">&times;</button>
            </div>
            <div class="modal-body">
                <h4>üìä Durchgef√ºhrte Aktionen:</h4>
                <div id="modalResults" class="modal-results"></div>
                <div id="modalDuration" class="modal-duration"></div>
            </div>
            <div class="modal-footer">
                <button id="modalCloseBtn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div id="devTools"
        style="display:none; position:fixed; bottom:10px; right:10px; background:#333; color:#fff; padding:10px; border-radius:5px; z-index:9999;">
        <div style="margin-bottom:8px;">
            <label>
                <input type="checkbox" id="telemetryToggle" />
                Worker Telemetry
            </label>
        </div>
        <div style="display:flex; gap:8px;">
            <button id="printTelemetry" style="padding:4px 8px; cursor:pointer;">Print</button>
            <button id="exportTelemetry" style="padding:4px 8px; cursor:pointer;">Export JSON</button>
        </div>
    </div>
    <script>
        if (window.location.search.includes('dev=true')) {
            const devTools = document.getElementById('devTools');
            const toggle = document.getElementById('telemetryToggle');
            const printBtn = document.getElementById('printTelemetry');
            const exportBtn = document.getElementById('exportTelemetry');

            if (devTools && toggle) {
                devTools.style.display = 'block';
                toggle.checked = localStorage.getItem('enableWorkerTelemetry') === 'true';
                toggle.addEventListener('change', e => {
                    localStorage.setItem('enableWorkerTelemetry', e.target.checked);
                    alert('Telemetry ' + (e.target.checked ? 'aktiviert' : 'deaktiviert') + '. Seite neu laden.');
                });
            }

            const getRegistry = () => {
                if (!(window.__workerTelemetryRegistry instanceof Map)) {
                    window.__workerTelemetryRegistry = new Map();
                }
                return window.__workerTelemetryRegistry;
            };

            if (printBtn) {
                printBtn.addEventListener('click', () => {
                    const registry = getRegistry();
                    if (!registry || registry.size === 0) {
                        console.warn('[Telemetry] Keine Telemetry-Instanzen gefunden.');
                        return;
                    }
                    for (const telemetry of registry.values()) {
                        if (telemetry && typeof telemetry.printReport === 'function') {
                            telemetry.printReport();
                        }
                    }
                });
            }

            if (exportBtn) {
                exportBtn.addEventListener('click', async () => {
                    const registry = getRegistry();
                    if (!registry || registry.size === 0) {
                        console.warn('[Telemetry] Keine Telemetry-Instanzen gefunden.');
                        return;
                    }
                    const report = {};
                    for (const [name, telemetry] of registry.entries()) {
                        if (telemetry && typeof telemetry.getReport === 'function') {
                            report[name] = telemetry.getReport();
                        }
                    }
                    const json = JSON.stringify(report, null, 2);
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        try {
                            await navigator.clipboard.writeText(json);
                            alert('Telemetry JSON kopiert.');
                        } catch (err) {
                            console.warn('[Telemetry] Clipboard fehlgeschlagen:', err);
                            console.log(json);
                        }
                    } else {
                        console.log(json);
                    }
                });
            }
        }
    </script>

</body>

</html>
