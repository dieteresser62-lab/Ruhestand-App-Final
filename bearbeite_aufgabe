#!/usr/bin/env bash
set -euo pipefail

TASK_FILE="${1:-Aufgabe.md}"
STATE_FILE=".orchestrator/state.json"
STATE_PHASE=""

if [[ -f "$STATE_FILE" ]]; then
  STATE_PHASE="$(python3 -c 'import json,sys
try:
    with open(sys.argv[1], encoding="utf-8") as f:
        data = json.load(f)
    print(str(data.get("phase", "")).strip())
except Exception:
    print("")
' "$STATE_FILE")"
fi

if [[ -f "$STATE_FILE" && "$STATE_PHASE" != "done" ]]; then
  echo "[INFO] Existing state found at $STATE_FILE -> resuming current run."
  python3 tools/ticketing/orchestrator.py \
    --resume \
    --allow-fallback-to-gemini \
    --agent-live-stream \
    --agent-live-stream-mode compact \
    --agent-live-stream-channels stdout \
    --agent-output none \
    --task-file "$TASK_FILE"
else
  if [[ -f "$STATE_FILE" && "$STATE_PHASE" == "done" ]]; then
    echo "[INFO] Existing state is completed (phase=done) -> starting new run."
  fi
  python3 tools/ticketing/orchestrator.py \
    --force-overwrite-state \
    --allow-fallback-to-gemini \
    --agent-live-stream \
    --agent-live-stream-mode compact \
    --agent-live-stream-channels stdout \
    --agent-output none \
    --task-file "$TASK_FILE"
fi
