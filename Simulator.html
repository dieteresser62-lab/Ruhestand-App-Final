<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruhestandsmodell-Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="simulator.css">
    <style>
        .debug-actions {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: .5rem
        }

        .btn-debug {
            font-size: .8rem;
            padding: .25rem .5rem;
            border-radius: .5rem;
            border: 1px solid #3b82f6;
            background: transparent;
            color: #1f3b8f;
            cursor: pointer
        }

        .btn-debug:hover {
            background: #eaf2ff
        }

        .dev-only {
            display: none
        }

        .dev-on .dev-only {
            display: block
        }

        .debug-link {
            font-size: .8rem;
            padding: .1rem .3rem;
            border: 1px solid #d6e6ff;
            border-radius: .4rem;
            color: #3b82f6;
            text-decoration: none
        }

        .debug-link:hover {
            background: #f3f8ff
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        /* Log Export Buttons - wie toggle-btn */
        .log-export-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 10px;
        }

        .log-export-buttons button {
            padding: 4px 10px;
            font-size: 0.75rem;
            border: 1px solid var(--border-color, #d1d5db);
            background-color: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            width: auto !important;
            min-width: 0 !important;
            flex: 0 0 auto !important;
        }

        .log-export-buttons button:hover {
            border-color: var(--secondary-color, #9ca3af);
            background-color: #e5e5e5;
        }

        /* Log Container - Option A: Moderne Card-Style */
        #worstRunLog,
        #simulationLog {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            font-size: 0.8rem;
        }

        #worstRunLog table,
        #simulationLog table {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            color: #000000;
        }

        #worstRunLog tr:nth-child(even),
        #simulationLog tr:nth-child(even) {
            background: #f3f4f6;
        }

        #worstRunLog tr:hover,
        #simulationLog tr:hover {
            background: #e5e7eb;
        }

        #worstRunLog th,
        #simulationLog th {
            background: #e5e7eb;
            font-weight: 600;
            color: #000000;
            position: sticky;
            top: 0;
        }

        #worstRunLog td,
        #simulationLog td {
            color: #000000;
        }

        #worstRunLog td,
        #simulationLog td,
        #worstRunLog th,
        #simulationLog th {
            padding: 6px 8px;
            border-bottom: 1px solid #d1d5db;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <div class="panel">
            <h1>Ruhestand-Simulator</h1>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="rahmendaten">Rahmendaten</button>
                <button class="tab-btn" data-tab="montecarlo">Monte-Carlo</button>
                <button class="tab-btn" data-tab="backtesting">Backtesting</button>
                <button class="tab-btn" data-tab="sweep">Parameter-Sweep</button>
            </div>

            <div class="tab-content">
                <div id="tab-rahmendaten" class="tab-panel active">
                    <fieldset class="collapsible" data-fieldset="portfolio">
                        <legend><span class="section-icon">üí∞</span>Startportfolio & Bedarf<span class="progress-indicator"></span></legend>
                        <div class="fieldset-content">
                            <div class="form-grid">
                                <div class="form-group"><label for="simStartVermoegen">Gesamtverm√∂gen (‚Ç¨)</label><input
                                        type="number" id="simStartVermoegen" value="2500000"></div>
                                <div class="form-group"><label for="depotwertAlt">davon Depotwert Alt (‚Ç¨)</label><input
                                        type="number" id="depotwertAlt" value="1250000"></div>
                                <div class="form-group"><label for="zielLiquiditaet">davon Ziel-Liquidit√§t (‚Ç¨)</label><input
                                        type="number" id="zielLiquiditaet" value="180000"></div>
                            </div>
                            <div class="form-grid"
                                style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                                <div class="form-group"><label for="startFloorBedarf">Start Floor-Bedarf p.a.
                                        (‚Ç¨)</label><input type="number" id="startFloorBedarf" value="24000"></div>
                                <div class="form-group"><label for="startFlexBedarf">Start Flex-Bedarf p.a.
                                        (‚Ç¨)</label><input type="number" id="startFlexBedarf" value="28000"></div>
                                <div class="form-group"><label for="marketCapeRatio">Aktueller CAPE (Shiller)</label><input
                                        type="number" id="marketCapeRatio" value="32" step="0.1" min="0"></div>
                                <div class="form-group"><label for="einstandAlt">Einstand Depot Alt (‚Ç¨)</label><input
                                        type="number" id="einstandAlt" value="700000"></div>
                                <div class="form-group"><label>Einstand Depot Neu (‚Ç¨)</label><input type="number"
                                        id="einstandNeu" placeholder="wird berechnet" disabled></div>
                            </div>
                            <div id="displayPortfolioBreakdown"
                                style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="collapsible" data-fieldset="gold">
                        <legend><span class="section-icon">ü•á</span>Gold-Strategie<span class="progress-indicator"></span></legend>
                        <div class="fieldset-content">
                            <div class="form-group" style="justify-content: center;">
                                <label style="flex-direction: row; align-items: center;">
                                    <input type="checkbox" id="goldAllokationAktiv" style="width: auto; margin-right: 8px;"
                                        checked>
                                    Gold-Allokation aktiv
                                </label>
                            </div>
                            <div id="goldStrategyPanel" style="display: none;">
                                <div class="form-grid-four-col">
                                    <div class="form-group">
                                        <label for="goldAllokationProzent">Ziel-Allokation (% v. Depot)</label>
                                        <input type="number" id="goldAllokationProzent" value="7.5" step="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="goldFloorProzent">Gold-Floor (% v. Gesamt)</label>
                                        <input type="number" id="goldFloorProzent" value="1" step="0.5">
                                    </div>
                                    <div class="form-group">
                                        <label for="rebalancingBand">Rebalancing-Band (¬± %)</label>
                                        <input type="number" id="rebalancingBand" value="25" step="5">
                                    </div>
                                    <div class="form-group" style="grid-column: span 2; justify-content: center;">
                                        <label style="flex-direction: row; align-items: center;">
                                            <input type="checkbox" id="goldSteuerfrei"
                                                style="width: auto; margin-right: 8px;" checked> Gold-Verk√§ufe steuerfrei
                                            (simuliert >1J Haltefrist)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="collapsible collapsed" data-fieldset="rebalancing">
                        <legend><span class="section-icon">‚öñÔ∏è</span>Runway & Rebalancing<span class="progress-indicator"></span></legend>
                        <div class="fieldset-content">
                            <h4 style="margin-top: 0; margin-bottom: 12px; font-size: 0.95rem;">Runway-Steuerung</h4>
                            <div class="form-grid" style="margin-bottom: 20px;">
                                <div class="form-group">
                                    <label for="runwayMinMonths">Runway Minimum (Monate)</label>
                                    <input type="number" id="runwayMinMonths" value="24" min="12" max="60">
                                </div>
                                <div class="form-group">
                                    <label for="runwayTargetMonths">Runway Ziel (Monate)</label>
                                    <input type="number" id="runwayTargetMonths" value="36" min="18" max="72">
                                </div>
                            </div>
                            <h4 style="margin-bottom: 12px; font-size: 0.95rem; padding-top: 15px; border-top: 1px solid var(--border-color);">Rebalancing-Strategie</h4>
                            <div class="form-grid-four-col">
                                <div class="form-group">
                                    <label for="targetEq">Aktien-Zielquote (%)</label>
                                    <input type="number" id="targetEq" value="60" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label for="rebalBand">Rebalancing-Band (¬±%)</label>
                                    <input type="number" id="rebalBand" value="5" min="1" max="50">
                                </div>
                                <div class="form-group">
                                    <label for="maxSkimPctOfEq">Max. Absch√∂pfen p.a. (%)</label>
                                    <input type="number" id="maxSkimPctOfEq" value="10" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label for="maxBearRefillPctOfEq">Max. Auff√ºllen (B√§r) (%)</label>
                                    <input type="number" id="maxBearRefillPctOfEq" value="5" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="collapsible collapsed" data-fieldset="personen">
                        <legend><span class="section-icon">üë§</span>Personen & Rente<span class="progress-indicator"></span></legend>
                        <div class="fieldset-content">
                            <div class="form-grid-four-col" style="align-items: end;">
                            <div class="form-group"><label for="p1StartAlter">Startalter</label><input type="number"
                                    id="p1StartAlter" value="63"></div>
                            <div class="form-group"><label for="p1Geschlecht">Geschlecht</label>
                                <select id="p1Geschlecht">
                                    <option value="m" selected>M√§nnlich</option>
                                    <option value="w">Weiblich</option>
                                    <option value="d">Divers</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="p1SparerPauschbetrag">Sparer-Pauschbetrag
                                    (‚Ç¨)</label><input type="number" id="p1SparerPauschbetrag" value="1000"></div>
                            <div class="form-group"><label for="p1KirchensteuerPct">Kirchensteuer</label>
                                <select id="p1KirchensteuerPct">
                                    <option value="0">0 %</option>
                                    <option value="8">8 %</option>
                                    <option value="9" selected>9 %</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="p1Monatsrente">Monatliche Rente (‚Ç¨)</label><input
                                    type="number" id="p1Monatsrente" value="500"></div>
                            <div class="form-group"><label for="p1StartInJahren">Start in ... Jahren</label><input
                                    type="number" id="p1StartInJahren" value="5"></div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="rentAdjMode">Rentenanpassung koppeln an</label>
                                <select id="rentAdjMode">
                                    <option value="fix">Fixer Prozentsatz</option>
                                    <option value="wage" selected>Lohnentwicklung (hist. Daten)</option>
                                    <option value="cpi">Inflation</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rentAdjPct">Rentenanpassung (% p.a.)</label>
                                <input type="number" id="rentAdjPct" step="0.1" value="2.0"
                                    title="Gemeinsame Rentenanpassung f√ºr beide Personen">
                            </div>
                            <!-- VERALTET: Alte Felder (versteckt, nur f√ºr Abw√§rtskompatibilit√§t) -->
                            <input type="hidden" id="startAlter">
                            <input type="hidden" id="geschlecht">
                            <input type="hidden" id="startSPB">
                            <input type="hidden" id="kirchensteuerSatz">
                            <input type="hidden" id="renteMonatlich">
                            <input type="hidden" id="renteStartOffsetJahre">
                            <div class="form-group" id="renteIndexierungsartContainer"
                                style="display: none; grid-column: span 2;">
                                <label for="renteIndexierungsart">Rentenanpassung koppeln an</label>
                                <select id="renteIndexierungsart">
                                    <option value="lohn" selected>Lohnentwicklung (hist. Daten)</option>
                                    <option value="inflation">Inflation (VPI)</option>
                                    <option value="fest">Festen Satz p.a.</option>
                                </select>
                            </div>
                            <div class="form-group" id="festerSatzContainer" style="display: none;">
                                <label for="renteFesterSatz">Fester Satz (% p.a.)</label>
                                <input type="number" id="renteFesterSatz" value="2.0" step="0.1">
                            </div>
                        </div>

                        <!-- Partner/Zweite Person (Rente 2) -->
                        <div style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                            <div class="form-group" style="justify-content: center; margin-bottom: 15px;">
                                <label style="flex-direction: row; align-items: center;">
                                    <input type="checkbox" id="chkPartnerAktiv" style="width: auto; margin-right: 8px;">
                                    Partner aktivieren (zweite Person)
                                </label>
                            </div>
                            <div id="sectionRente2" style="display: none;">
                                <div class="form-grid-four-col">
                                    <div class="form-group">
                                        <label for="r2StartAlter">Startalter</label>
                                        <input type="number" id="r2StartAlter" min="0" max="120" value="60">
                                    </div>
                                    <div class="form-group">
                                        <label for="r2Geschlecht">Geschlecht</label>
                                        <select id="r2Geschlecht">
                                            <option value="w" selected>Weiblich</option>
                                            <option value="m">M√§nnlich</option>
                                            <option value="d">Divers</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="r2SparerPauschbetrag">Sparer-Pauschbetrag (‚Ç¨)</label>
                                        <input type="number" id="r2SparerPauschbetrag" min="0" step="50" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="r2KirchensteuerPct">Kirchensteuer</label>
                                        <select id="r2KirchensteuerPct">
                                            <option value="0" selected>0 %</option>
                                            <option value="8">8 %</option>
                                            <option value="9">9 %</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="r2Monatsrente">Monatliche Rente (‚Ç¨)</label>
                                        <input type="number" id="r2Monatsrente" min="0" step="10" value="1500">
                                    </div>
                                    <div class="form-group">
                                        <label for="r2StartInJahren">Start in ‚Ä¶ Jahren</label>
                                        <input type="number" id="r2StartInJahren" min="0" max="120" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="r2Steuerquote">Steuerquote (%)</label>
                                        <input type="number" id="r2Steuerquote" min="0" max="100" step="0.1" value="0"
                                            title="Optionaler Pauschalsatz. 0 = keine Pauschalsteuer.">
                                    </div>
                                    <!-- VERALTET: Alte Felder (versteckt, nur f√ºr Abw√§rtskompatibilit√§t) -->
                                    <input type="hidden" id="r2Brutto">
                                    <div class="form-group" id="r2AnpassungContainer" style="display: none;">
                                        <label for="r2Anpassung">Rentenanpassung (% p.a.)</label>
                                        <input type="number" id="r2Anpassung" step="0.1" value="2.0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="widowPensionSection"
                            style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                            <h4 style="margin-bottom: 10px;">Hinterbliebenenrente</h4>
                            <div class="form-grid-four-col">
                                <div class="form-group">
                                    <label for="widowPensionMode">Verhalten bei Todesfall</label>
                                    <select id="widowPensionMode">
                                        <option value="stop" selected>Rente endet vollst√§ndig</option>
                                        <option value="percent">Witwen-/Witwerrente (Prozent)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="widowPensionPct">Prozentsatz der Witwenrente (%)</label>
                                    <input type="number" id="widowPensionPct" min="0" max="100" step="5" value="55">
                                </div>
                                <div class="form-group">
                                    <label for="widowMarriageOffsetYears">Eheschlie√üung in ‚Ä¶ Jahren</label>
                                    <input type="number" id="widowMarriageOffsetYears" min="0" max="120" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="widowMinMarriageYears">Mindest-Ehedauer f√ºr Anspruch (Jahre)</label>
                                    <input type="number" id="widowMinMarriageYears" min="0" max="120" value="1">
                                </div>
                            </div>
                            <p class="form-hint" style="grid-column: span 4; margin-top: 10px;">
                                Hinweis: Die Witwen-/Witwerrente wird nur gezahlt, wenn die Eheschlie√üung erfolgt ist
                                und die Mindestdauer erreicht wurde.
                            </p>
                        </div>
                        </div>
                    </fieldset>

                    <fieldset class="collapsible collapsed" data-fieldset="pflege">
                        <legend><span class="section-icon">üè•</span>Pflegefall-Absicherung<span class="progress-indicator"></span></legend>
                        <div class="fieldset-content">
                        <div id="pflegePanelContainer" class="care-panel" style="border-top: none; margin-top: 0; padding-top: 0;">
                            <div class="care-panel-toggle">
                                <label class="care-inline-toggle">
                                    <input type="checkbox" id="pflegefallLogikAktivieren" checked>
                                    Pflegefall-Logik aktiv
                                </label>
                                <p class="care-panel-subtitle">Definiere Kostenverlauf, Pflegedauer und
                                    Mortalit√§tsanpassungen klar getrennt.</p>
                            </div>
                            <!-- Die Sektionen strukturieren die Pflegekonfiguration in √ºberschaubare Teilbereiche -->
                            <div id="pflegePanel" class="care-sections">
                                <section class="care-section">
                                    <div class="care-section-header">
                                        <h4>Pflegemodell &amp; Verlauf</h4>
                                        <p>Lege fest, wie lange die Pflege dauert und wie schnell der Bedarf ansteigt.
                                        </p>
                                    </div>
                                    <div class="care-section-grid">
                                        <div class="form-group">
                                            <label for="pflegeModellTyp">Pflegemodell-Typ</label>
                                            <select id="pflegeModellTyp">
                                                <option value="chronisch" selected>Chronisch (bis Lebensende)</option>
                                                <option value="akut">Akut (begrenzte Dauer)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="pflegeRampUp">Anstiegsdauer (Jahre)</label>
                                            <input type="number" id="pflegeRampUp" value="5">
                                        </div>
                                        <div id="pflegeDauerContainer" class="care-duration-group">
                                            <div class="form-group">
                                                <label for="pflegeMinDauer">Min. Pflegedauer (Jahre)</label>
                                                <input type="number" id="pflegeMinDauer" value="5" min="1" step="1">
                                            </div>
                                            <div class="form-group">
                                                <label for="pflegeMaxDauer">Max. Pflegedauer (Jahre)</label>
                                                <input type="number" id="pflegeMaxDauer" value="10" min="1" step="1">
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <section class="care-section">
                                    <div class="care-section-header">
                                        <h4>Kostenprofil &amp; Flex</h4>
                                        <p>Bestimme Zusatzbedarf, Flex-Verlust und den Floor-Cap.</p>
                                    </div>
                                    <div class="care-section-grid care-config-grid">
                                        <div class="form-group" style="grid-column: span 2;">
                                            <label for="pflegeKostenStaffelPreset">Kostenstaffel je Pflegegrad</label>
                                            <select id="pflegeKostenStaffelPreset">
                                                <option value="custom" selected>Individuelle Werte</option>
                                                <option value="ambulant">Ambulant (ab 36 Tsd. ‚Ç¨)</option>
                                                <option value="stationaer">Station√§r (Premium)</option>
                                            </select>
                                            <small id="pflegeStaffelPresetHint">W√§hle ein Preset, um typische
                                                Staffelungen zu √ºbernehmen.</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="pflegeMaxFloor">Maximaler Pflege-Floor (‚Ç¨ p.a.)</label>
                                            <input type="number" id="pflegeMaxFloor" value="120000">
                                        </div>
                                        <div class="form-group">
                                            <label for="pflegeRegionalZuschlag">Regionaler Zuschlag (%)</label>
                                            <input type="number" id="pflegeRegionalZuschlag" value="0" step="0.5"
                                                min="0">
                                            <small>Multipliziert alle Pflegegrade z.&nbsp;B. f√ºr
                                                Metropol-Zuschl√§ge.</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="pflegeKostenDrift">Zus√§tzl. Kostenanstieg p.a. (%)</label>
                                            <input type="number" id="pflegeKostenDrift" value="3.5" step="0.1" min="0">
                                            <small>Konservativer Aufschlag (Default: 3,5&nbsp;%) zus√§tzlich zur
                                                Inflation.</small>
                                        </div>
                                    </div>
                                    <div class="care-grade-matrix" aria-label="Einstellungen pro Pflegegrad">
                                        <div class="care-grade-row care-grade-header">
                                            <div>Pflegegrad</div>
                                            <div>Zusatzbedarf (‚Ç¨ p.a.)</div>
                                            <div>Flex-Level (%)</div>
                                            <div>Max. Mortalit√§ts-Faktor*</div>
                                        </div>
                                        <div class="care-grade-row">
                                            <div class="care-grade-label">
                                                <strong>Pflegegrad 1</strong>
                                                <small>Leichte Beeintr√§chtigung, Einstieg</small>
                                            </div>
                                            <div><input type="number" id="pflegeStufe1Zusatz" value="6000" min="0"
                                                    step="500"></div>
                                            <div><input type="number" id="pflegeStufe1FlexCut" value="75" min="0"
                                                    max="100"></div>
                                            <div><input type="number" id="pflegeStufe1Mortality" value="0" min="0"
                                                    step="0.1"></div>
                                        </div>
                                        <div class="care-grade-row">
                                            <div class="care-grade-label">
                                                <strong>Pflegegrad 2</strong>
                                                <small>Erhebliche Beeintr√§chtigung</small>
                                            </div>
                                            <div><input type="number" id="pflegeStufe2Zusatz" value="12000" min="0"
                                                    step="500"></div>
                                            <div><input type="number" id="pflegeStufe2FlexCut" value="25" min="0"
                                                    max="100"></div>
                                            <div><input type="number" id="pflegeStufe2Mortality" value="0" min="0"
                                                    step="0.1"></div>
                                        </div>
                                        <div class="care-grade-row">
                                            <div class="care-grade-label">
                                                <strong>Pflegegrad 3</strong>
                                                <small>Schwere Beeintr√§chtigung</small>
                                            </div>
                                            <div><input type="number" id="pflegeStufe3Zusatz" value="18000" min="0"
                                                    step="500"></div>
                                            <div><input type="number" id="pflegeStufe3FlexCut" value="10" min="0"
                                                    max="100"></div>
                                            <div><input type="number" id="pflegeStufe3Mortality" value="3" min="0"
                                                    step="0.1"></div>
                                        </div>
                                        <div class="care-grade-row">
                                            <div class="care-grade-label">
                                                <strong>Pflegegrad 4</strong>
                                                <small>Schwerste Beeintr√§chtigung</small>
                                            </div>
                                            <div><input type="number" id="pflegeStufe4Zusatz" value="32000" min="0"
                                                    step="500"></div>
                                            <div><input type="number" id="pflegeStufe4FlexCut" value="0" min="0"
                                                    max="100"></div>
                                            <div><input type="number" id="pflegeStufe4Mortality" value="5" min="0"
                                                    step="0.1"></div>
                                        </div>
                                        <div class="care-grade-row">
                                            <div class="care-grade-label">
                                                <strong>Pflegegrad 5</strong>
                                                <small>Schwerste + besondere Anforderungen</small>
                                            </div>
                                            <div><input type="number" id="pflegeStufe5Zusatz" value="60000" min="0"
                                                    step="500"></div>
                                            <div><input type="number" id="pflegeStufe5FlexCut" value="0" min="0"
                                                    max="100"></div>
                                            <div><input type="number" id="pflegeStufe5Mortality" value="5" min="0"
                                                    step="0.1"></div>
                                        </div>
                                    </div>
                                    <small class="care-grade-note">*0 = keine Erh√∂hung, Werte &gt; 1 multiplizieren das
                                        Basismortalit√§tsrisiko nach Ablauf der Ramp-Up-Dauer. Mortalit√§tsfaktoren
                                        pflegestufen-spezifisch hier im Panel einstellen.</small>
                                </section>
                            </div>
                        </div>
                        </div>
                    </fieldset>
                </div>

                <div id="tab-montecarlo" class="tab-panel">
                    <fieldset>
                        <legend><span class="section-icon">üé≤</span>Simulationsparameter</legend>
                        <div class="form-grid-four-col">
                            <div class="form-group"><label for="mcAnzahl">Anzahl Simulationen</label><input
                                    type="number" id="mcAnzahl" value="1000"></div>
                            <div class="form-group"><label for="mcDauer">Maximale Dauer (Jahre)</label><input
                                    type="number" id="mcDauer" value="35"></div>
                            <div class="form-group"><label for="mcBlockSize">Blockgr√∂√üe (Jahre)</label><input
                                    type="number" id="mcBlockSize" value="5"></div>
                            <div class="form-group"><label for="mcSeed">Seed</label><input type="number" id="mcSeed"
                                    value="12345"></div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="mcMethode">Simulationsmethode</label>
                            <select id="mcMethode">
                                <option value="regime_markov" selected>Regime-Sampling (Markov-Chain)</option>
                                <option value="regime_iid">Regime-Sampling (iid)</option>
                                <option value="block">Block-Bootstrap (Stresstest)</option>
                            </select>
                        </div>
                        <div class="form-group" style="justify-content: center; margin-top: 10px;">
                            <label style="flex-direction: row; align-items: center;"
                                title="Wenn aktiv, werden Startjahre bevorzugt, deren historisches CAPE dem aktuellen Eingabewert √§hnelt (+/- 20%).">
                                <input type="checkbox" id="useCapeSampling" style="width: auto; margin-right: 8px;">
                                CAPE-basiertes Sampling verwenden
                            </label>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend><span class="section-icon">‚ö°</span>Stressmodus</legend>
                        <div class="form-group">
                            <label for="stressPreset">Szenario f√ºr die ersten Simulationsjahre</label>
                            <select id="stressPreset">
                                <!-- Wird per JavaScript bef√ºllt -->
                            </select>
                        </div>
                    </fieldset>
                    <button id="mcButton" onclick="runMonteCarlo()">Monte-Carlo-Simulation starten</button>
                    <div id="mc-progress-bar-container">
                        <div id="mc-progress-bar"></div>
                    </div>
                    <div id="monteCarloResults" style="display:none; margin-top: 25px;">
                        <h3>Ergebnisse der Monte-Carlo-Analyse</h3>
                        <div id="monteCarloSummary"></div>

                        <div id="unifiedKpiDashboard" style="display:none;"></div>
                        <div id="advancedKpiDashboard" style="display:none;"></div>
                        <div id="withdrawalRateChartContainer"></div>

                        <div id="pflegeKpiResults" style="display:none;">
                            <h3 style="border-top: 1px solid var(--border-color); padding-top: 25px;">Analyse des
                                Pflegerisikos</h3>
                            <div id="pflegeKpiSummary" class="summary-grid"></div>
                        </div>
                        <div id="worstRunLogContainer" style="display:none; margin-top: 25px;">
                            <h4 style="text-align:center;">Jahresprotokoll des schlechtesten Laufs (Worst Case)</h4>
                            <div id="worst-controls"
                                style="text-align: center; margin-bottom: 10px; font-size: 0.9rem; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <label style="user-select:none; cursor:pointer;"
                                    title="Zeige vollst√§ndige Pflege-Aufschl√ºsselung (Anker, Cap, Deltas, Flex-Faktor).">
                                    <input type="checkbox" id="toggle-care-details"
                                        style="width:auto; vertical-align: middle; margin-right: 4px;">
                                    Pflege-Details anzeigen
                                </label>
                                <label style="user-select:none; cursor:pointer;"
                                    title="Umschalten zwischen normalem (kompakt) und detailliertem (alle Spalten) Log.">
                                    <input type="checkbox" id="toggle-log-detail"
                                        style="width:auto; vertical-align: middle; margin-right: 4px;">
                                    Detailliertes Log anzeigen
                                </label>
                            </div>
                            <div id="worstRunLog"></div>
                            <div class="log-export-buttons">
                                <button type="button" id="exportWorstLogJson">JSON</button>
                                <button type="button" id="exportWorstLogCsv">CSV</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-backtesting" class="tab-panel">
                    <fieldset>
                        <legend><span class="section-icon">üìÖ</span>Backtesting-Parameter</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label for="simStartJahr">Startjahr</label><input type="number"
                                    id="simStartJahr" value="2000"></div>
                            <div class="form-group"><label for="simEndJahr">Endjahr</label><input type="number"
                                    id="simEndJahr" value="2023"></div>
                        </div>
                    </fieldset>
                    <button id="btButton" onclick="runBacktest()">Historische Simulation starten</button>
                    <div id="simulationResults" style="display:none; margin-top: 25px;">
                        <h3>Ergebnis des Backtests</h3>
                        <div id="simulationSummary"></div>
                        <h4 style="text-align:center; margin-top:20px;">Jahresprotokoll</h4>
                        <div style="text-align: center; margin-bottom: 10px; font-size: 0.9rem;">
                            <label style="user-select:none; cursor:pointer;"
                                title="Umschalten zwischen normalem (kompakt) und detailliertem (alle Spalten) Log.">
                                <input type="checkbox" id="toggle-backtest-detail"
                                    style="width:auto; vertical-align: middle; margin-right: 4px;">
                                Detailliertes Log anzeigen
                            </label>
                        </div>
                        <div id="simulationLog">Keine Daten</div>
                        <div class="log-export-buttons">
                            <button type="button" id="exportBacktestJson">JSON</button>
                            <button type="button" id="exportBacktestCsv">CSV</button>
                        </div>
                    </div>
                    <div id="engine-mismatch-footer"></div>
                    <section class="dev-only" id="parity-smoketest-card">
                        <fieldset style="margin-top: 25px;">
                            <div class="section-title">
                                <h3 style="margin:0">Parity Smoke Test</h3>
                                <a id="runParitySmokeTestBtn" class="debug-link" href="javascript:void(0)"
                                    onclick="window.runParitySmokeTest({years:3})"
                                    aria-label="Run Parity Smoke Test">Run</a>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">Vergleicht Engine und
                                Simulator √ºber 3 Jahre. Ergebnisse in der Browser-Konsole.</div>
                        </fieldset>
                    </section>
                </div>

                <div id="tab-sweep" class="tab-panel">
                    <fieldset>
                        <legend><span class="section-icon">üîÑ</span>Sweep-Ranges</legend>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.85rem; color: #555;">
                            <div>
                                <strong>Format:</strong> start:step:end (z.B. 24:6:48) oder Liste 50,60,70 oder
                                Einzelwert 24
                            </div>
                            <div id="sweepGridSize" style="font-weight: 600; color: var(--secondary-color);">
                                Grid: 0 Kombis
                            </div>
                        </div>
                        <div class="form-grid-four-col">
                            <div class="form-group"><label for="sweepRunwayMin">Runway Min (Monate)</label><input
                                    type="text" id="sweepRunwayMin" value="18" placeholder="12,18,24"
                                    title="Format: start:step:end (z.B. 18:6:36) oder Liste 12,18,24 oder Einzelwert 18">
                            </div>
                            <div class="form-group"><label for="sweepRunwayTarget">Runway Target (Monate)</label><input
                                    type="text" id="sweepRunwayTarget" value="24:6:36" placeholder="18:6:36"
                                    title="Format: start:step:end (z.B. 18:6:36) oder Liste 18,24,30 oder Einzelwert 24">
                            </div>
                            <div class="form-group"><label for="sweepTargetEq">Target Eq (%)</label><input type="text"
                                    id="sweepTargetEq" value="50,60,70" placeholder="50,60,70"
                                    title="Format: start:step:end (z.B. 50:10:80) oder Liste 50,60,70 oder Einzelwert 60">
                            </div>
                            <div class="form-group"><label for="sweepRebalBand">Rebal Band (%)</label><input type="text"
                                    id="sweepRebalBand" value="5" placeholder="3,5,7"
                                    title="Format: start:step:end (z.B. 3:2:9) oder Liste 3,5,7 oder Einzelwert 5">
                            </div>
                            <div class="form-group"><label for="sweepMaxSkimPct">Max Skim % of Eq</label><input
                                    type="text" id="sweepMaxSkimPct" value="2" placeholder="0,2,4"
                                    title="Format: start:step:end (z.B. 0:2:6) oder Liste 0,2,4 oder Einzelwert 2">
                            </div>
                            <div class="form-group"><label for="sweepMaxBearRefillPct">Max Bear Refill % of
                                    Eq</label><input type="text" id="sweepMaxBearRefillPct" value="2"
                                    placeholder="0,2,4"
                                    title="Format: start:step:end (z.B. 0:2:8) oder Liste 0,2,4 oder Einzelwert 2">
                            </div>
                            <div class="form-group"><label for="sweepGoldTargetPct">Gold Target (%)</label><input
                                    type="text" id="sweepGoldTargetPct" value="5,7.5" placeholder="0,2.5,5,7.5"
                                    title="Format: start:step:end (z.B. 0:2.5:10) oder Liste 0,2.5,5,7.5 oder Einzelwert 7.5">
                            </div>
                        </div>
                    </fieldset>
                    <button id="sweepButton" onclick="runParameterSweep()">Run Sweep</button>
                    <div id="sweep-progress-bar-container"
                        style="display:none; width: 100%; background-color: #e0e0e0; height: 24px; border-radius: 4px; margin-top: 15px; overflow: hidden;">
                        <div id="sweep-progress-bar"
                            style="width: 0%; height: 100%; background-color: var(--secondary-color); transition: width 0.3s; line-height: 24px; text-align: center; color: white; font-size: 0.85rem;">
                        </div>
                    </div>

                    <!-- Selbsttest-Panel (nur bei ?debug=1 sichtbar) -->
                    <div id="sweepSelfTestPanel" class="dev-only"
                        style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
                        <h4 style="margin-top: 0;">üß™ Sweep-Selbsttest (Debug)</h4>
                        <p style="font-size: 0.85rem; color: #666;">
                            F√ºhrt einen Mini-Sweep mit 3 F√§llen aus (nur rebalBand-Variation) und pr√ºft, ob R2 konstant
                            bleibt.
                        </p>
                        <button id="sweepSelfTestButton" onclick="runSweepSelfTest()">Selbsttest ausf√ºhren</button>
                        <div id="sweepSelfTestResults" style="margin-top: 10px; display: none;"></div>
                    </div>
                    <div id="sweepResults" style="display:none; margin-top: 25px;">
                        <h3>Sweep Ergebnisse</h3>
                        <div id="sweepControls" style="margin-bottom: 15px;">
                            <div class="form-grid-four-col">
                                <div class="form-group">
                                    <label for="sweepMetric">Metrik</label>
                                    <select id="sweepMetric">
                                        <option value="successProbFloor" selected>Success Prob Floor</option>
                                        <option value="p10EndWealth">P10 End Wealth</option>
                                        <option value="worst5Drawdown">Worst 5% Drawdown</option>
                                        <option value="minRunwayObserved">Min Runway Observed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sweepAxisX">X-Achse Parameter</label>
                                    <select id="sweepAxisX">
                                        <option value="runwayMin">Runway Min</option>
                                        <option value="runwayTarget" selected>Runway Target</option>
                                        <option value="targetEq">Target Eq</option>
                                        <option value="rebalBand">Rebal Band</option>
                                        <option value="maxSkimPct">Max Skim Pct</option>
                                        <option value="maxBearRefillPct">Max Bear Refill Pct</option>
                                        <option value="goldTargetPct">Gold Target Pct</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sweepAxisY">Y-Achse Parameter</label>
                                    <select id="sweepAxisY">
                                        <option value="runwayMin">Runway Min</option>
                                        <option value="runwayTarget">Runway Target</option>
                                        <option value="targetEq" selected>Target Eq</option>
                                        <option value="rebalBand">Rebal Band</option>
                                        <option value="maxSkimPct">Max Skim Pct</option>
                                        <option value="maxBearRefillPct">Max Bear Refill Pct</option>
                                        <option value="goldTargetPct">Gold Target Pct</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="sweepHeatmap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="engine.js" defer></script>
    <script src="sim-parity-smoketest.js" defer></script>
    <script type="module" src="simulator-main.js"></script>

    <!-- Accordion Toggle & Progress Indicator Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Accordion toggle
            document.querySelectorAll('fieldset.collapsible legend').forEach(legend => {
                legend.addEventListener('click', function(e) {
                    // Don't toggle if clicking on the indicator
                    if (e.target.classList.contains('progress-indicator')) return;
                    const fieldset = this.closest('fieldset');
                    fieldset.classList.toggle('collapsed');
                });
            });

            // Progress indicator update function
            function updateProgressIndicators() {
                document.querySelectorAll('fieldset.collapsible[data-fieldset]').forEach(fieldset => {
                    const inputs = fieldset.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), select');
                    let hasData = false;

                    inputs.forEach(input => {
                        if (input.disabled) return;
                        const value = input.value;
                        const defaultValue = input.defaultValue;

                        // Check if value differs from default or has meaningful data
                        if (value && value !== '' && value !== '0') {
                            hasData = true;
                        }
                    });

                    // Always show as filled if there are any inputs with values
                    if (hasData) {
                        fieldset.classList.add('has-data');
                    } else {
                        fieldset.classList.remove('has-data');
                    }
                });
            }

            // Initial check
            updateProgressIndicators();

            // Update on input changes
            document.querySelectorAll('#tab-rahmendaten input, #tab-rahmendaten select').forEach(input => {
                input.addEventListener('change', updateProgressIndicators);
                input.addEventListener('input', updateProgressIndicators);
            });
        });
    </script>

    <script>
        (function () {
            const DEV_KEY = "sim.devMode";
            const urlDev = new URLSearchParams(location.search).get("dev") === "1";
            const saved = localStorage.getItem(DEV_KEY) === "1";
            const dev = urlDev || saved;
            const root = document.body;
            function setDevMode(on) {
                localStorage.setItem(DEV_KEY, on ? "1" : "0");
                root.classList.toggle("dev-on", !!on);
            }
            setDevMode(dev);
            window.addEventListener("keydown", (e) => {
                if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "d") {
                    const on = !root.classList.contains("dev-on");
                    setDevMode(on);
                    e.preventDefault();
                }
            });
        })();
    </script>
</body>

</html>