<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruhestandsmodell-Simulator</title>
    <link rel="stylesheet" href="simulator.css">
    <style>
.debug-actions{margin-left:auto;display:inline-flex;align-items:center;gap:.5rem}
.btn-debug{font-size:.8rem;padding:.25rem .5rem;border-radius:.5rem;border:1px solid #3b82f6;background:transparent;color:#1f3b8f;cursor:pointer}
.btn-debug:hover{background:#eaf2ff}
.dev-only{display:none}
.dev-on .dev-only{display:block}
.debug-link{font-size:.8rem;padding:.1rem .3rem;border:1px solid #d6e6ff;border-radius:.4rem;color:#3b82f6;text-decoration:none}
.debug-link:hover{background:#f3f8ff}
.section-title{display:flex;align-items:center;justify-content:space-between}
    </style>
</head>
<body>

    <div class="main-layout">
        <div class="panel">
            <h1>Ruhestand-Simulator</h1>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="rahmendaten">Rahmendaten</button>
                <button class="tab-btn" data-tab="montecarlo">Monte-Carlo</button>
                <button class="tab-btn" data-tab="backtesting">Backtesting</button>
                <button class="tab-btn" data-tab="sweep">Parameter-Sweep</button>
            </div>

            <div class="tab-content">
                <div id="tab-rahmendaten" class="tab-panel active">
            <fieldset>
                <legend>Startportfolio & Bedarf</legend>
                <div class="form-grid">
                    <div class="form-group"><label for="simStartVermoegen">Gesamtvermögen (€)</label><input type="number" id="simStartVermoegen" value="2500000"></div>
                    <div class="form-group"><label for="depotwertAlt">davon Depotwert Alt (€)</label><input type="number" id="depotwertAlt" value="1250000"></div>
                    <div class="form-group"><label for="zielLiquiditaet">davon Ziel-Liquidität (€)</label><input type="number" id="zielLiquiditaet" value="180000"></div>
                    <div class="form-group"><label for="simRisikoprofil">Risikoprofil</label>
                        <select id="simRisikoprofil">
                           <option value="sicherheits-dynamisch" selected>Sicherheits-Dynamisch</option>
                        </select>
                    </div>
                </div>
                 <div class="form-grid" style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                    <div class="form-group"><label for="startFloorBedarf">Start Floor-Bedarf p.a. (€)</label><input type="number" id="startFloorBedarf" value="24000"></div>
                    <div class="form-group"><label for="startFlexBedarf">Start Flex-Bedarf p.a. (€)</label><input type="number" id="startFlexBedarf" value="28000"></div>
                    <div class="form-group"><label for="einstandAlt">Einstand Depot Alt (€)</label><input type="number" id="einstandAlt" value="700000"></div>
                    <div class="form-group"><label>Einstand Depot Neu (€)</label><input type="number" id="einstandNeu" placeholder="wird berechnet" disabled></div>
                 </div>
                 <div id="displayPortfolioBreakdown" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;"></div>
            </fieldset>

            <fieldset>
                <legend>Strategie-Parameter</legend>
                <div class="form-group" style="justify-content: center;">
                    <label style="flex-direction: row; align-items: center;">
                        <input type="checkbox" id="goldAllokationAktiv" style="width: auto; margin-right: 8px;" checked>
                        Gold-Allokation aktiv
                    </label>
                </div>
                <div id="goldStrategyPanel" style="display: none;">
                    <div class="form-grid-four-col">
                        <div class="form-group">
                            <label for="goldAllokationProzent">Ziel-Allokation (% v. Depot)</label>
                            <input type="number" id="goldAllokationProzent" value="7.5" step="1">
                        </div>
                        <div class="form-group">
                            <label for="goldFloorProzent">Gold-Floor (% v. Gesamt)</label>
                            <input type="number" id="goldFloorProzent" value="1" step="0.5">
                        </div>
                         <div class="form-group">
                            <label for="rebalancingBand">Rebalancing-Band (± %)</label>
                            <input type="number" id="rebalancingBand" value="25" step="5">
                        </div>
                        <div class="form-group" style="grid-column: span 2; justify-content: center;">
                            <label style="flex-direction: row; align-items: center;">
                                <input type="checkbox" id="goldSteuerfrei" style="width: auto; margin-right: 8px;" checked> Gold-Verkäufe steuerfrei (simuliert >1J Haltefrist)
                            </label>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <fieldset>
                <legend>Entnahme-Modus</legend>
                <div class="form-grid-three-col">
                    <div class="form-group" style="grid-column: 1 / span 1;">
                        <label for="decumulationMode">Zielsetzung</label>
                        <select id="decumulationMode">
                            <option value="none" selected>Vermögen erhalten (Standard)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 10px; justify-content: center;">
                    <label style="flex-direction: row; align-items: center;">
                        <input type="checkbox" id="round5" style="width: auto; margin-right: 8px;">
                        Kürzung in 5-%-Schritten runden
                    </label>
                </div>
            </fieldset>

            <fieldset>
                <legend>Allgemeine & Externe Parameter</legend>
                 <div class="form-grid-four-col" style="align-items: end;">
                        <div class="form-group"><label for="startAlter">Startalter</label><input type="number" id="startAlter" value="63"></div>
                        <div class="form-group"><label for="geschlecht">Geschlecht</label>
                           <select id="geschlecht"><option value="m" selected>Männlich</option><option value="w">Weiblich</option></select>
                        </div>
                        <div class="form-group"><label for="startSPB">Sparer-Pauschbetrag (€)</label><input type="number" id="startSPB" value="1000"></div>
                        <div class="form-group"><label for="kirchensteuerSatz">Kirchensteuer</label>
                           <select id="kirchensteuerSatz"><option value="0">0 %</option><option value="0.08">8 %</option><option value="0.09" selected>9 %</option></select>
                       </div>
                       <div class="form-group"><label for="renteMonatlich">Monatliche Rente (€)</label><input type="number" id="renteMonatlich" value="500"></div>
                       <div class="form-group"><label for="renteStartOffsetJahre">Start in ... Jahren</label><input type="number" id="renteStartOffsetJahre" value="5"></div>
                       <div class="form-group">
                           <label for="rentAdjPct">Rentenanpassung (% p.a.)</label>
                           <input type="number" id="rentAdjPct" step="0.1" value="2.0" placeholder="Gilt für Rente 1 und Rente 2" title="Gemeinsame Rentenanpassung für beide Personen">
                       </div>
                       <!-- VERALTET: Alte Indexierungslogik (versteckt, nur für Abwärtskompatibilität) -->
                       <div class="form-group" id="renteIndexierungsartContainer" style="display: none; grid-column: span 2;">
                           <label for="renteIndexierungsart">Rentenanpassung koppeln an</label>
                           <select id="renteIndexierungsart">
                               <option value="lohn" selected>Lohnentwicklung (hist. Daten)</option>
                               <option value="inflation">Inflation (VPI)</option>
                               <option value="fest">Festen Satz p.a.</option>
                           </select>
                       </div>
                       <div class="form-group" id="festerSatzContainer" style="display: none;">
                           <label for="renteFesterSatz">Fester Satz (% p.a.)</label>
                           <input type="number" id="renteFesterSatz" value="2.0" step="0.1">
                       </div>
                </div>

                 <!-- Partner/Zweite Person (Rente 2) -->
                 <div style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                    <div class="form-group" style="justify-content: center; margin-bottom: 15px;">
                        <label style="flex-direction: row; align-items: center;">
                            <input type="checkbox" id="chkPartnerAktiv" style="width: auto; margin-right: 8px;">
                            Partner aktivieren (zweite Person)
                        </label>
                    </div>
                    <div id="sectionRente2" style="display: none;">
                        <div class="form-grid-four-col">
                            <div class="form-group">
                                <label for="r2StartAlter">Startalter Partner</label>
                                <input type="number" id="r2StartAlter" min="0" max="120" value="60">
                            </div>
                            <div class="form-group">
                                <label for="r2Brutto">Bruttorente p.a. (€)</label>
                                <input type="number" id="r2Brutto" min="0" step="100" value="18000">
                            </div>
                            <div class="form-group">
                                <label for="r2Steuerquote">Steuerquote (%)</label>
                                <input type="number" id="r2Steuerquote" min="0" max="100" step="0.1" value="0">
                            </div>
                            <!-- VERALTET: Separate Anpassung für R2 (versteckt, nur für Abwärtskompatibilität) -->
                            <div class="form-group" id="r2AnpassungContainer" style="display: none;">
                                <label for="r2Anpassung">Rentenanpassung (% p.a.)</label>
                                <input type="number" id="r2Anpassung" step="0.1" value="2.0">
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background-color: #f0f7ff; border-left: 3px solid var(--secondary-color); font-size: 0.85rem; color: #555;">
                            ℹ️ Die Rentenanpassung wird gemeinsam mit Rente 1 gesteuert (siehe Feld "Rentenanpassung" bei Person 1).
                        </div>
                    </div>
                 </div>

                 <div id="pflegePanelContainer" style="grid-column: 1 / -1; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                    <div class="form-group" style="justify-content: center; margin-bottom: 15px;">
                        <label style="flex-direction: row; align-items: center; justify-content: center;">
                            <input type="checkbox" id="pflegefallLogikAktivieren" checked style="width: auto; margin-right: 8px;">
                            Pflegefall-Logik aktiv
                        </label>
                    </div>
                    <div id="pflegePanel" class="form-grid-four-col">
                        <div class="form-group" style="grid-column: 1 / span 2;">
                            <label for="pflegeModellTyp">Pflegemodell-Typ</label>
                            <select id="pflegeModellTyp">
                                <option value="chronisch" selected>Chronisch (bis Lebensende)</option>
                                <option value="akut">Akut (begrenzte Dauer)</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 3 / span 2; justify-content: center;">
                                <label style="flex-direction: row; align-items: center; justify-content: center; height: 100%;"><input type="checkbox" id="pflegebeschleunigtMortalitaetAktivieren" checked style="width: auto; margin-right: 8px;">Beschleunigte Mortalität bei Max-Pflege</label>
                        </div>
                        <div class="form-group">
                            <label for="pflegeStufe1Zusatz">Zusatzbedarf Stufe 1 (€ p.a.)</label>
                            <input type="number" id="pflegeStufe1Zusatz" value="12000">
                        </div>
                        <div class="form-group">
                            <label for="pflegeStufe1FlexCut">Flex-Reduktion auf (%)</label>
                            <input type="number" id="pflegeStufe1FlexCut" value="50">
                        </div>
                            <div class="form-group">
                            <label for="pflegeMaxFloor">Maximaler Pflege-Floor (€ p.a.)</label>
                            <input type="number" id="pflegeMaxFloor" value="60000">
                        </div>
                        <div class="form-group">
                            <label for="pflegeRampUp">Anstiegsdauer (Jahre)</label>
                            <input type="number" id="pflegeRampUp" value="5">
                        </div>
                        <div id="pflegeDauerContainer" style="grid-column: 1 / -1; display: contents;">
                            <div class="form-grid-four-col" style="grid-column: 1 / -1; gap: 20px;">
                                <div class="form-group">
                                    <label for="pflegeMinDauer">Min. Pflegedauer (Jahre)</label>
                                    <input type="number" id="pflegeMinDauer" value="3">
                                </div>
                                <div class="form-group">
                                    <label for="pflegeMaxDauer">Max. Pflegedauer (Jahre)</label>
                                    <input type="number" id="pflegeMaxDauer" value="8">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pflegeKostenDrift">Zusätzl. Kostenanstieg p.a. (%)</label>
                            <input type="number" id="pflegeKostenDrift" value="1.5">
                        </div>
                        <div class="form-group" id="pflegeTodesrisikoContainer">
                            <label for="pflegeTodesrisikoFaktor">Todesrisiko-Faktor bei Max-Pflege</label>
                            <input type="number" id="pflegeTodesrisikoFaktor" value="5.0" step="0.1">
                        </div>
                    </div>
                </div>
            </fieldset>
                </div>

                <div id="tab-montecarlo" class="tab-panel">
            <h2>Monte-Carlo-Simulation</h2>
            <fieldset>
                <div class="form-grid-four-col">
                    <div class="form-group"><label for="mcAnzahl">Anzahl Simulationen</label><input type="number" id="mcAnzahl" value="1000"></div>
                    <div class="form-group"><label for="mcDauer">Maximale Dauer (Jahre)</label><input type="number" id="mcDauer" value="35"></div>
                    <div class="form-group"><label for="mcBlockSize">Blockgröße (Jahre)</label><input type="number" id="mcBlockSize" value="5"></div>
                    <div class="form-group"><label for="mcSeed">Seed</label><input type="number" id="mcSeed" value="12345"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="mcMethode">Simulationsmethode</label>
                    <select id="mcMethode">
                        <option value="regime_markov" selected>Regime-Sampling (Markov-Chain)</option>
                        <option value="regime_iid">Regime-Sampling (iid)</option>
                        <option value="block">Block-Bootstrap (Stresstest)</option>
                    </select>
                </div>
            </fieldset>
			<fieldset>
                <legend>Stressmodus</legend>
                <div class="form-group">
                    <label for="stressPreset">Szenario für die ersten Simulationsjahre</label>
                    <select id="stressPreset">
                        <!-- Wird per JavaScript befüllt -->
                    </select>
                </div>
            </fieldset>
            <button id="mcButton" onclick="runMonteCarlo()">Monte-Carlo-Simulation starten</button>
            <div id="mc-progress-bar-container"><div id="mc-progress-bar"></div></div>
             <div id="monteCarloResults" style="display:none; margin-top: 25px;">
                <h3>Ergebnisse der Monte-Carlo-Analyse</h3>
                <div id="monteCarloSummary"></div>
                
                <div id="unifiedKpiDashboard" style="display:none;"></div>
                <div id="advancedKpiDashboard" style="display:none;"></div>
                <div id="withdrawalRateChartContainer"></div>
                
                <div id="pflegeKpiResults" style="display:none;">
                    <h3 style="border-top: 1px solid var(--border-color); padding-top: 25px;">Analyse des Pflegerisikos</h3>
                    <div id="pflegeKpiSummary" class="summary-grid"></div>
                </div>
                <div id="worstRunLogContainer" style="display:none; margin-top: 25px;">
                    <h4 style="text-align:center;">Jahresprotokoll des schlechtesten Laufs (Worst Case)</h4>
					<div id="worst-controls" style="text-align: center; margin-bottom: 10px; font-size: 0.9rem;">
                      <label style="user-select:none; cursor:pointer;" title="Zeige vollständige Pflege-Aufschlüsselung (Anker, Cap, Deltas, Flex-Faktor).">
                        <input type="checkbox" id="toggle-care-details" style="width:auto; vertical-align: middle; margin-right: 4px;">
                        Pflege-Details anzeigen
                      </label>
                    </div>					
                    <div id="worstRunLog"></div>
                </div>
             </div>
                </div>

                <div id="tab-backtesting" class="tab-panel">
             <h2>Historisches Backtesting</h2>
            <fieldset>
                <legend>Backtesting-Parameter</legend>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group"><label for="simStartJahr">Startjahr</label><input type="number" id="simStartJahr" value="2000"></div>
                    <div class="form-group"><label for="simEndJahr">Endjahr</label><input type="number" id="simEndJahr" value="2023"></div>
                </div>
            </fieldset>
            <button id="btButton" onclick="runBacktest()">Historische Simulation starten</button>
             <div id="simulationResults" style="display:none; margin-top: 25px;"><h3>Ergebnis des Backtests</h3><div id="simulationSummary"></div><h4 style="text-align:center; margin-top:20px;">Jahresprotokoll</h4><div id="simulationLog">Keine Daten</div></div>
             <div id="engine-mismatch-footer"></div>
             <section class="dev-only" id="parity-smoketest-card">
             <fieldset style="margin-top: 25px;">
                <div class="section-title">
                    <h3 style="margin:0">Parity Smoke Test</h3>
                    <a id="runParitySmokeTestBtn" class="debug-link" href="javascript:void(0)" onclick="window.runParitySmokeTest({years:3})" aria-label="Run Parity Smoke Test">Run</a>
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">Vergleicht Engine und Simulator über 3 Jahre. Ergebnisse in der Browser-Konsole.</div>
            </fieldset>
             </section>
                </div>

                <div id="tab-sweep" class="tab-panel">
            <h2>Parameter-Sweep</h2>
            <fieldset>
                <legend>Sweep-Ranges</legend>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.85rem; color: #555;">
                    <div>
                        <strong>Format:</strong> start:step:end (z.B. 24:6:48) oder Liste 50,60,70 oder Einzelwert 24
                    </div>
                    <div id="sweepGridSize" style="font-weight: 600; color: var(--secondary-color);">
                        Grid: 0 Kombis
                    </div>
                </div>
                <div class="form-grid-four-col">
                    <div class="form-group"><label for="sweepRunwayMin">Runway Min (Monate)</label><input type="text" id="sweepRunwayMin" value="18" placeholder="12,18,24" title="Format: start:step:end (z.B. 18:6:36) oder Liste 12,18,24 oder Einzelwert 18"></div>
                    <div class="form-group"><label for="sweepRunwayTarget">Runway Target (Monate)</label><input type="text" id="sweepRunwayTarget" value="24:6:36" placeholder="18:6:36" title="Format: start:step:end (z.B. 18:6:36) oder Liste 18,24,30 oder Einzelwert 24"></div>
                    <div class="form-group"><label for="sweepTargetEq">Target Eq (%)</label><input type="text" id="sweepTargetEq" value="50,60,70" placeholder="50,60,70" title="Format: start:step:end (z.B. 50:10:80) oder Liste 50,60,70 oder Einzelwert 60"></div>
                    <div class="form-group"><label for="sweepRebalBand">Rebal Band (%)</label><input type="text" id="sweepRebalBand" value="5" placeholder="3,5,7" title="Format: start:step:end (z.B. 3:2:9) oder Liste 3,5,7 oder Einzelwert 5"></div>
                    <div class="form-group"><label for="sweepMaxSkimPct">Max Skim % of Eq</label><input type="text" id="sweepMaxSkimPct" value="2" placeholder="0,2,4" title="Format: start:step:end (z.B. 0:2:6) oder Liste 0,2,4 oder Einzelwert 2"></div>
                    <div class="form-group"><label for="sweepMaxBearRefillPct">Max Bear Refill % of Eq</label><input type="text" id="sweepMaxBearRefillPct" value="2" placeholder="0,2,4" title="Format: start:step:end (z.B. 0:2:8) oder Liste 0,2,4 oder Einzelwert 2"></div>
                    <div class="form-group"><label for="sweepGoldTargetPct">Gold Target (%)</label><input type="text" id="sweepGoldTargetPct" value="5,7.5" placeholder="0,2.5,5,7.5" title="Format: start:step:end (z.B. 0:2.5:10) oder Liste 0,2.5,5,7.5 oder Einzelwert 7.5"></div>
                </div>
            </fieldset>
            <button id="sweepButton" onclick="runParameterSweep()">Run Sweep</button>
            <div id="sweep-progress-bar-container" style="display:none; width: 100%; background-color: #e0e0e0; height: 24px; border-radius: 4px; margin-top: 15px; overflow: hidden;">
                <div id="sweep-progress-bar" style="width: 0%; height: 100%; background-color: var(--secondary-color); transition: width 0.3s; line-height: 24px; text-align: center; color: white; font-size: 0.85rem;"></div>
            </div>
            <div id="sweepResults" style="display:none; margin-top: 25px;">
                <h3>Sweep Ergebnisse</h3>
                <div id="sweepControls" style="margin-bottom: 15px;">
                    <div class="form-grid-four-col">
                        <div class="form-group">
                            <label for="sweepMetric">Metrik</label>
                            <select id="sweepMetric">
                                <option value="successProbFloor" selected>Success Prob Floor</option>
                                <option value="p10EndWealth">P10 End Wealth</option>
                                <option value="worst5Drawdown">Worst 5% Drawdown</option>
                                <option value="minRunwayObserved">Min Runway Observed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sweepAxisX">X-Achse Parameter</label>
                            <select id="sweepAxisX">
                                <option value="runwayMin">Runway Min</option>
                                <option value="runwayTarget" selected>Runway Target</option>
                                <option value="targetEq">Target Eq</option>
                                <option value="rebalBand">Rebal Band</option>
                                <option value="maxSkimPct">Max Skim Pct</option>
                                <option value="maxBearRefillPct">Max Bear Refill Pct</option>
                                <option value="goldTargetPct">Gold Target Pct</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sweepAxisY">Y-Achse Parameter</label>
                            <select id="sweepAxisY">
                                <option value="runwayMin">Runway Min</option>
                                <option value="runwayTarget">Runway Target</option>
                                <option value="targetEq" selected>Target Eq</option>
                                <option value="rebalBand">Rebal Band</option>
                                <option value="maxSkimPct">Max Skim Pct</option>
                                <option value="maxBearRefillPct">Max Bear Refill Pct</option>
                                <option value="goldTargetPct">Gold Target Pct</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="sweepHeatmap"></div>
            </div>
                </div>
            </div>
        </div>
    </div>


<script src="engine.js" defer></script>
<script src="sim-parity-smoketest.js" defer></script>
<script type="module" src="simulator-main.js"></script>
<script>
  (function(){
    const DEV_KEY = "sim.devMode";
    const urlDev = new URLSearchParams(location.search).get("dev") === "1";
    const saved = localStorage.getItem(DEV_KEY) === "1";
    const dev = urlDev || saved;
    const root = document.body;
    function setDevMode(on){
      localStorage.setItem(DEV_KEY, on ? "1" : "0");
      root.classList.toggle("dev-on", !!on);
    }
    setDevMode(dev);
    window.addEventListener("keydown", (e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "d"){
        const on = !root.classList.contains("dev-on");
        setDevMode(on);
        e.preventDefault();
      }
    });
  })();
</script>
</body>
</html>
